<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Jadwal & Absensi Kurir — Sahabatku Delivery</title>
<style>
/* ===== Reset & Root ===== */
/* Reset dasar */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  /* Palet warna biru langit */
  --primary: #3a8dde;          /* biru langit cerah */
  --primary-dark: #1e5fa8;     /* biru langit gelap */
  --bg: #e8f4fd;               /* biru langit sangat terang */
  --ok: #43a047;               /* hijau sukses */
  --danger: #e53935;           /* merah bahaya */
  --pending: #f9a825;          /* kuning pending */
  --text: #1a2e4a;             /* biru navy gelap */
  --text-muted: #5a6d8c;       /* biru abu */
  --radius: 16px;
  --shadow-light: rgba(58, 141, 222, 0.15);
  --shadow-strong: rgba(58, 141, 222, 0.25);
  --popup-duration: 5000ms;
  --transition-speed: 0.3s;
}

/* Body dan font */
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Ubuntu, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
  font-size: 16px;
}

/* Container utama */
.container {
  max-width: 1200px;
  margin: 24px auto;
  padding: 24px 32px;
}

/* Card */
.card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: 0 12px 30px var(--shadow-light);
  padding: 28px 32px;
  transition: box-shadow var(--transition-speed) ease;
}

.card:hover {
  box-shadow: 0 16px 40px var(--shadow-strong);
}

/* Judul utama */
h1 {
  color: var(--primary-dark);
  text-align: center;
  font-weight: 900;
  font-size: clamp(24px, 4vw, 36px);
  margin-bottom: 24px;
  letter-spacing: 0.04em;
  text-shadow: 0 1px 3px rgba(58, 141, 222, 0.2);
}

/* Tombol Kembali (sticky pojok kanan) */
.btn-kembali {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #f97316; /* oranye */
  color: #fff;
  padding: 12px 20px;
  border-radius: 14px;
  font-weight: 700;
  font-size: 15px;
  text-decoration: none;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
  transition: background var(--transition-speed) ease, transform var(--transition-speed) ease;
  z-index: 1000;
  user-select: none;
}

.btn-kembali:hover,
.btn-kembali:focus {
  background: #ea580c;
  transform: translateY(-2px);
  outline: none;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
}

/* Topbar & Admin bar */
.topbar,
.admin-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  justify-content: center;
  margin: 12px 0 20px;
}

.topbar .btn,
.admin-bar .btn {
  padding: 12px 18px;
  border: none;
  border-radius: 14px;
  background: var(--primary);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  transition: filter var(--transition-speed) ease, transform var(--transition-speed) ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  user-select: none;
}

.topbar .btn:hover,
.admin-bar .btn:hover,
.topbar .btn:focus,
.admin-bar .btn:focus {
  filter: brightness(0.9);
  transform: translateY(-2px);
  outline: none;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
}

.topbar .btn.ghost {
  background: #e8f4fb;
  color: var(--primary-dark);
  box-shadow: none;
  border: 1.5px solid var(--primary);
}

.topbar .btn.active {
  background: var(--primary-dark);
  box-shadow: 0 6px 20px var(--shadow-strong);
}

.admin-bar .btn.alt {
  background: #e8f4fb;
  color: var(--primary-dark);
  box-shadow: none;
  border: 1.5px solid var(--primary);
}

.admin-bar .btn.danger {
  background: var(--danger);
  box-shadow: none;
}

.admin-bar {
  display: none; /* bisa diaktifkan sesuai kebutuhan */
}

/* Tabs */
.tab {
  display: none;
}

.tab.active {
  display: block;
}

/* Table wrapper */
.table-wrap {
  overflow-x: auto;
  border-radius: var(--radius);
  border: 1.5px solid #d6e4f0;
  margin-top: 16px;
  box-shadow: 0 6px 20px rgba(58, 141, 222, 0.05);
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
  color: var(--text);
  min-width: 600px;
}

thead th {
  position: sticky;
  top: 0;
  background: var(--primary);
  color: #fff;
  font-weight: 700;
  padding: 14px 16px;
  letter-spacing: 0.03em;
  z-index: 10;
  text-align: center;
  user-select: none;
  box-shadow: inset 0 -3px 6px rgba(0, 0, 0, 0.1);
}

tbody td {
  padding: 14px 16px;
  border-bottom: 1.5px solid #d6e4f0;
  text-align: center;
  transition: background var(--transition-speed) ease;
}

tbody tr:hover td {
  background: #d9eaff;
  cursor: default;
}

/* Badges */
.badge {
  display: inline-block;
  padding: 7px 16px;
  border-radius: 9999px;
  font-weight: 700;
  font-size: 13px;
  user-select: none;
  transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
  white-space: nowrap;
}

.badge.on {
  background: #e9f7ef;
  color: #1b5e20;
  border: 1.5px solid #cdebd6;
}

.badge.off {
  background: #ffebee;
  color: #b71c1c;
  border: 1.5px solid #ffcdd2;
}

.badge.pending {
  background: #fff8e1;
  color: #f9a825;
  border: 1.5px solid #ffe082;
}

/* Mini Buttons */
.btn-mini {
  padding: 8px 14px;
  border: none;
  border-radius: 14px;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  transition: filter var(--transition-speed) ease, transform var(--transition-speed) ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  user-select: none;
  font-size: 14px;
}

.btn-on {
  background: var(--ok);
}

.btn-off {
  background: var(--danger);
}

.btn-pending {
  background: var(--pending);
}

.btn-on:hover,
.btn-off:hover,
.btn-pending:hover,
.btn-on:focus,
.btn-off:focus,
.btn-pending:focus {
  filter: brightness(0.9);
  transform: translateY(-2px);
  outline: none;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
}

/* Overlay Login */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: saturate(1.2) blur(6px);
}

.overlay.active {
  display: flex;
}

.login {
  background: #fff;
  width: min(92vw, 460px);
  border-radius: 20px;
  box-shadow: 0 12px 30px var(--shadow-light);
  padding: 28px 32px;
  text-align: center;
  user-select: none;
}

.login h3 {
  color: var(--primary-dark);
  margin-bottom: 20px;
  font-weight: 800;
  font-size: 1.5rem;
  letter-spacing: 0.03em;
}

.login input {
  width: 100%;
  padding: 14px 16px;
  border: 1.5px solid #cfe5f5;
  border-radius: 14px;
  margin: 12px 0;
  font-size: 1rem;
  color: var(--text);
  transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
}

.login input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 12px var(--primary);
  outline: none;
  background: #f0f8ff;
}

.login .btn {
  width: 100%;
  padding: 14px 0;
  border: none;
  border-radius: 14px;
  background: var(--primary);
  color: #fff;
  font-weight: 900;
  font-size: 1.1rem;
  cursor: pointer;
  transition: background var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
  user-select: none;
}

.login .btn:hover,
.login .btn:focus {
  background: var(--primary-dark);
  box-shadow: 0 8px 24px var(--shadow-strong);
  outline: none;
}

/* Small text */
.small {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 12px;
  user-select: none;
}

/* Popup */
#popup {
  position: fixed;
  top: 14px;
  right: 14px;
  width: min(92vw, 340px);
  background: rgba(255, 255, 255, 0.95);
  color: var(--text);
  border: 1.5px solid #d6e4f0;
  border-left: 6px solid var(--ok);
  border-radius: 16px;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.16);
  padding: 16px 20px;
  display: none;
  z-index: 9998;
  backdrop-filter: saturate(1.2) blur(6px);
  opacity: 0;
  transform: translateY(-16px);
  transition: opacity 0.35s ease, transform 0.35s ease, border-color 0.25s ease;
  user-select: none;
}

#popup.show {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

#popup .title {
  font-weight: 800;
  margin-bottom: 6px;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--primary-dark);
}

#popup .meta {
  font-size: 13px;
  color: var(--text-muted);
}

/* Dropdown modern */
select {
  padding: 12px 16px;
  border: 1.5px solid #cfe5f5;
  border-radius: 14px;
  min-width: 220px;
  background: #f8fcff;
  cursor: pointer;
  transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
  font-weight: 600;
  color: var(--text);
  user-select: none;
}

select:hover,
select:focus {
  border-color: var(--primary);
  box-shadow: 0 6px 18px rgba(58, 141, 222, 0.25);
  outline: none;
}

/* Form pengajuan */
#pengajuanForm {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
  align-items: center;
  justify-content: center;
  background: #f8fcff;
  padding: 20px 24px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(58, 141, 222, 0.08);
  border: 1.5px solid #d6e4f0;
}

#pengajuanForm select {
  min-width: 200px;
  padding: 12px 16px;
  border-radius: 14px;
  border: 1.5px solid #cfe5f5;
  background: white;
  font-weight: 600;
  color: var(--text);
  transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
}

#pengajuanForm select:hover,
#pengajuanForm select:focus {
  border-color: var(--primary);
  box-shadow: 0 6px 18px rgba(58, 141, 222, 0.25);
  outline: none;
}

#pengajuanForm button {
  background: var(--primary);
  border-radius: 14px;
  padding: 12px 20px;
  color: #fff;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: filter var(--transition-speed) ease, transform var(--transition-speed) ease;
  user-select: none;
  border: none;
  box-shadow: 0 6px 20px rgba(58, 141, 222, 0.2);
}

#pengajuanForm button:hover,
#pengajuanForm button:focus {
  filter: brightness(0.9);
  transform: translateY(-2px);
  outline: none;
  box-shadow: 0 8px 24px rgba(58, 141, 222, 0.3);
}

/* Responsive */
@media (max-width: 900px) {
  .container {
    padding: 16px 20px;
  }
  #pengajuanForm {
    flex-direction: column;
    gap: 16px;
  }
  .topbar,
  .admin-bar {
    justify-content: flex-start;
  }
  .topbar .btn,
  .admin-bar .btn {
    flex: 1 1 100%;
  }
  table {
    font-size: 14px;
  }
}

@media (max-width: 600px) {
  h1 {
    font-size: clamp(20px, 6vw, 28px);
  }
  .btn-kembali {
    padding: 10px 16px;
    font-size: 14px;
  }
  table {
    min-width: 100%;
    font-size: 13px;
  }
  #pengajuanForm select {
    min-width: 100%;
  }
/* ===== Penyesuaian Mobile (max-width: 600px) ===== */
@media (max-width: 600px) {
  /* Container padding lebih kecil */
  .container {
    padding: 16px 16px;
  }

  /* Judul lebih kecil dan rapat */
  h1 {
    font-size: clamp(20px, 7vw, 28px);
    margin-bottom: 16px;
  }

  /* Tombol kembali lebih kecil dan tidak terlalu besar */
  .btn-kembali {
    padding: 10px 14px;
    font-size: 14px;
    top: 14px;
    right: 14px;
  }

  /* Form pengajuan: kolom jadi satu, elemen melebar penuh */
  #pengajuanForm {
    flex-direction: column;
    gap: 16px;
    padding: 16px 16px;
  }
  #pengajuanForm select,
  #pengajuanForm button {
    min-width: 100% !important;
    width: 100% !important;
  }

  /* Tombol dan button di topbar/admin bar melebar penuh */
  .topbar,
  .admin-bar {
    justify-content: flex-start;
    gap: 12px;
  }
  .topbar .btn,
  .admin-bar .btn {
    flex: 1 1 100%;
    width: 100%;
  }

  /* Tabel: buat scroll horizontal dan font lebih kecil */
  .table-wrap {
    overflow-x: auto;
  }
  table {
    min-width: 100%;
    font-size: 13px;
  }
  thead th,
  tbody td {
    padding: 10px 8px;
  }

  /* Badge dan tombol mini lebih kecil */
  .badge {
    padding: 5px 10px;
    font-size: 11px;
  }
  .btn-mini {
    padding: 6px 10px;
    font-size: 12px;
  }

  /* Login overlay dan form lebih kecil dan rapat */
  .login {
    width: 90vw;
    padding: 20px 20px;
  }
  .login input {
    padding: 10px 12px;
    font-size: 0.9rem;
  }
  .login .btn {
    padding: 12px 0;
    font-size: 1rem;
  }
}

}

</style>
</head>
<body>
<div class="container">
<div class="card">
<h1>Jadwal & Absensi Kurir</h1>

<div class="topbar" id="topbar">
  <a href="index.html" class="btn-kembali"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
  <button class="btn active" data-tab="tab-jadwal">Jadwal Off</button>
  <button class="btn" data-tab="tab-rekap">Rekap & Keaktifan</button>
  <button class="btn ghost" id="btn-absensi-tab" data-tab="tab-absensi" style="display:none;">Absensi Harian</button>
  <button class="btn ghost" id="btn-approval-tab" data-tab="tab-approval" style="display:none;">Approval Kurir</button>
  <span class="split"></span>
  <div class="month-wrap">
    <label for="monthPick"><small>Bulan:</small></label>
    <input type="month" id="monthPick"/>
  </div>
  <button class="btn" id="btn-login">Login</button>
</div>

<div class="admin-bar" id="adminBar">
  <button class="btn alt" id="btn-save">Save Data (Firestore)</button>
  <button class="btn" id="btn-add">Tambah Kurir</button>
  <button class="btn danger" id="btn-del">Hapus Kurir</button>
  <button class="btn alt" id="btn-regen">Regenerasi Off</button>
  <button class="btn" id="btn-logout" style="display:none">Logout</button>
</div>

<!-- Tabs -->
<div id="tab-jadwal" class="tab active">
  <div id="pengajuanForm">
    <select id="pengajuanTanggal"></select>
    <select id="penggantiKurir"></select>
    <select id="tanggalTukar"></select>
    <button class="btn" id="btnAjukan">Ajukan Tukar Off</button>
  </div>
  <div class="table-wrap">
    <table id="tableJadwal">
      <thead><tr><th>Tanggal</th><th>Hari</th><th>Kurir Off</th><th>Pengganti</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="tab-absensi" class="tab">
  <div class="table-wrap">
    <table id="tableAbsensi">
      <thead><tr><th>Tanggal</th><th>Nama Kurir</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="tab-rekap" class="tab">
  <div class="table-wrap">
    <table id="tableRekap">
      <thead><tr><th>Nama Kurir</th><th>Total On</th><th>Total Off</th><th>Skor Keaktifan</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="tab-approval" class="tab">
  <div class="table-wrap">
    <table id="tableApproval">
      <thead><tr><th>Tanggal</th><th>Kurir Asal</th><th>Pengganti</th><th>Status</th><th>Aksi</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
</div>
</div>

<!-- Overlay Login -->
<div class="overlay" id="overlay">
  <div class="login">
    <h3>Login Admin (Firebase)</h3>
    <input id="fbEmail" placeholder="Email admin (Firebase)"/>
    <input id="fbPass" placeholder="Password (Firebase)" type="password"/>
    <button class="btn" id="doFirebaseLogin">Login</button>
    <div class="small">Akses admin hanya untuk UID: <code>J2rOyqBbEVaehucXpJl7jHh90Iz2</code></div>
    <div style="margin-top:10px">
      <button class="btn ghost" id="closeOverlay">Tutup</button>
    </div>
  </div>
</div>

<!-- Popup -->
<div id="popup">
  <div class="title"><span class="icon">✅</span><span id="popTitle">Semua On</span></div>
  <div class="meta" id="popMeta">–</div>
</div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase Init =====
const firebaseConfig = {
  apiKey: "AIzaSyD2tC4MlutCuUZvg06yGKT3jveaTGjtZAg",
  authDomain: "absensikurir.firebaseapp.com",
  projectId: "absensikurir",
  storageBucket: "absensikurir.firebasestorage.app",
  messagingSenderId: "395111603667",
  appId: "1:395111603667:web:119be647937508d890a326",
  measurementId: "G-V4L30EH9GP"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const ADMIN_UID = "J2rOyqBbEVaehucXpJl7jHh90Iz2";

// ===== Firestore Refs =====
const MASTER_DOC = db.collection('appdata').doc('master');
const JADWAL_COLLECTION = db.collection('jadwal_off');
const PENGAJUAN_COLLECTION = db.collection('pengajuan_off');

// ===== State =====
let kurirList = ["Sonia","Pitri","Hambali","Alfan","Gilang","Hafiz","Kardi","Robi","Ulum","Eblek","Nandar"]; // fallback awal
let jadwalData = {}; // { 'YYYY-MM': [ {tanggal, off, pengganti} ] }
let isFirebaseAdmin = false;
let unsubJadwal = null;  // listener jadwal per-bulan
let pengajuanCache = []; // diisi dari listener tunggal
const idDays = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];

// ===== Utils =====
const pad2 = n => String(n).padStart(2,'0');
const fmtISO = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const parseISODate = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); };

// ===== Popup =====
function popupShow(ok,title,meta){
  const el=document.getElementById('popup'); 
  el.classList.remove('ok','danger','pending'); 
  el.classList.add(ok==='pending'?'pending':ok?'ok':'danger');
  el.querySelector('.icon').textContent=ok==='pending'?'⏳':ok?'✅':'⚠️'; 
  document.getElementById('popTitle').textContent=title;
  document.getElementById('popMeta').textContent=meta||'';
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),5000);
}

// ===== Generate Jadwal Adil =====
function generateFairOffForMonth(ym){
  const [y,m]=ym.split('-').map(Number), year=y, month=m-1;
  const days = new Date(year, month+1, 0).getDate();
  const pool = kurirList.slice();
  if (pool.length === 0) { jadwalData[ym]=[]; return; }
  const counts = Object.fromEntries(pool.map(k=>[k,0]));
  const arr=[];
  for(let d=1; d<=days; d++){
    const minV = Math.min(...Object.values(counts));
    const cands = pool.filter(k=>counts[k]===minV);
    const pick = cands[Math.floor(Math.random()*cands.length)];
    counts[pick]+=1;
    const dt=new Date(year, month, d);
    arr.push({ tanggal: fmtISO(dt), off: pick, pengganti: '' });
  }
  jadwalData[ym]=arr;
}

// ===== Renderers =====
function renderJadwal(ym){
  const tbody = document.querySelector('#tableJadwal tbody'); 
  tbody.innerHTML='';
  if(!jadwalData[ym]) return;

  jadwalData[ym].forEach(it=>{
    const d = parseISODate(it.tanggal);
    const hari = idDays[d.getDay()];
    const tr = document.createElement('tr');

    const tdTanggal = document.createElement('td'); tdTanggal.textContent = it.tanggal;
    const tdHari = document.createElement('td'); tdHari.textContent = hari;

    const tdOff = document.createElement('td');
    const badge = document.createElement('span');
    badge.className = it.off ? 'badge off' : 'badge on';
    badge.textContent = it.off || 'Semua On';
    badge.style.cursor = 'pointer';
    badge.title = 'Klik untuk mengajukan tukar off';
    badge.onclick = ()=>{
      document.getElementById('pengajuanTanggal').value = it.tanggal;
      setupFormPengajuan();
      popupShow('pending','Tanggal dipilih','Silakan lengkapi form pengajuan');
    };
    tdOff.appendChild(badge);

    const tdPeng = document.createElement('td'); 
    tdPeng.textContent = it.pengganti || '—';

    if(isFirebaseAdmin){
      badge.oncontextmenu = async (e)=>{
        e.preventDefault();
        const nama = prompt('Set OFF hari ini untuk kurir (kosongkan untuk Semua On):', it.off || '');
        if(nama!==null){
          const newOff = nama.trim();
          it.off = newOff;
          it.pengganti = '';
          await saveFirestoreJadwal(ym);
          popupShow(true,'OFF diperbarui',`${it.tanggal}: ${it.off || 'Semua On'}`);
        }
      };
    }

    tr.append(tdTanggal, tdHari, tdOff, tdPeng);
    tbody.appendChild(tr);
  });
}

function renderAbsensi(ym){
  const tbody = document.querySelector('#tableAbsensi tbody'); 
  tbody.innerHTML='';
  if(!jadwalData[ym]) return;
  jadwalData[ym].forEach(it=>{
    kurirList.forEach(async k=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${it.tanggal}</td><td>${k}</td>`;
      let status = (k===it.off)?'Off':'On';
      const tdS=document.createElement('td');
      if(isFirebaseAdmin){
        const btn=document.createElement('button');
        btn.className='btn-mini ' + (status==='On'?'btn-on':'btn-off');
        btn.textContent=status;
        btn.onclick=async ()=>{
          // Toggle: jika sekarang On, maka set off ke k; jika Off, kosongkan (semua on)
          const ymLocal = it.tanggal.slice(0,7);
          const row = jadwalData[ymLocal].find(r=>r.tanggal===it.tanggal);
          row.off = (status==='On') ? k : '';
          row.pengganti = '';
          await saveFirestoreJadwal(ymLocal);
        };
        tdS.appendChild(btn);
      } else { 
        const span=document.createElement('span'); 
        span.className='badge '+(status==='On'?'on':'off'); 
        span.textContent=status; 
        tdS.appendChild(span); 
      }
      tr.appendChild(tdS); 
      tbody.appendChild(tr);
    });
  });
}

function renderRekap(ym){
  const tbody=document.querySelector('#tableRekap tbody'); 
  tbody.innerHTML='';
  if(!jadwalData[ym]) return;
  const arr=jadwalData[ym]; 
  const sum=Object.fromEntries(kurirList.map(k=>[k,{on:0,off:0}]));
  arr.forEach(it=>{ kurirList.forEach(k=>{ if(k===it.off) sum[k].off++; else sum[k].on++; }); });
  kurirList.forEach(k=>{
    const {on,off}=sum[k]; const total=on+off||1; const skor=Math.round((on/total)*100);
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${k}</td><td>${on}</td><td>${off}</td><td>${skor}%</td>`; 
    tbody.appendChild(tr);
  });
}

function renderApproval(){
  const tbody = document.querySelector('#tableApproval tbody'); 
  tbody.innerHTML='';
  pengajuanCache.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item.tanggal}</td><td>${item.asal}</td><td>${item.pengganti}</td><td>${item.status}</td>`;
    if(item.status==='Pending' && isFirebaseAdmin){
      const tdA = document.createElement('td');

      const btnApprove = document.createElement('button'); 
      btnApprove.textContent = 'Approve'; 
      btnApprove.className = 'btn-mini btn-on';
      btnApprove.onclick = async()=>{
        if(!confirm('Yakin ingin menyetujui pengajuan ini?')) return;
        const ym = item.tanggal.slice(0,7);
        if(!jadwalData[ym]) return;
        const row = jadwalData[ym].find(it=>it.tanggal===item.tanggal);
        const swapRow = jadwalData[ym].find(it=>it.tanggal===item.tukarTanggal);
        if(row && swapRow){
          const tmp = row.off; 
          row.off = swapRow.off; 
          swapRow.off = tmp;
          row.pengganti = ''; 
          swapRow.pengganti = '';
          await PENGAJUAN_COLLECTION.doc(item.id).update({status:'Approved', approvedBy:ADMIN_UID});
          await saveFirestoreJadwal(ym);
          popupShow(true,'Approval berhasil','Tanggal: '+item.tanggal+' ↔ '+item.tukarTanggal);
        }
      };
      tdA.appendChild(btnApprove);

      const btnReject = document.createElement('button');
      btnReject.textContent = 'Tolak';
      btnReject.className = 'btn-mini btn-off';
      btnReject.style.marginLeft = '6px';
      btnReject.onclick = async()=>{
        if(!confirm('Yakin ingin MENOLAK pengajuan ini?')) return;
        await PENGAJUAN_COLLECTION.doc(item.id).update({status:'Rejected', rejectedBy:ADMIN_UID});
        popupShow(false,'Pengajuan ditolak','Tanggal: '+item.tanggal);
      };
      tdA.appendChild(btnReject);

      tr.appendChild(tdA);
    } else {
      tr.appendChild(document.createElement('td'));
    }
    tbody.appendChild(tr);
  });
}

// ===== Quick Re-render =====
function quickSync(){ 
  const ym=document.getElementById('monthPick').value;
  renderJadwal(ym); 
  renderAbsensi(ym); 
  renderRekap(ym); 
  renderApproval();
}

// ===== Form Pengajuan =====
function setupFormPengajuan(){
  const tanggalSel = document.getElementById('pengajuanTanggal');
  const kurirSel = document.getElementById('penggantiKurir');
  const tanggalTukarSel = document.getElementById('tanggalTukar');
  const ym = document.getElementById('monthPick').value;

  tanggalSel.innerHTML = ''; 
  kurirSel.innerHTML=''; 
  tanggalTukarSel.innerHTML='';

  if(!jadwalData[ym]) return;

  // Isi pilihan tanggal apapun (agar jelas siapa off)
  jadwalData[ym].forEach(it=>{
    const opt = document.createElement('option'); 
    opt.value=it.tanggal;
    opt.textContent = it.tanggal + (it.off?` (Off: ${it.off})`:' (Semua On)');
    tanggalSel.appendChild(opt);
  });

  // Isi list kurir
  kurirList.forEach(k=>{
    const opt = document.createElement('option'); 
    opt.value=k; 
    opt.textContent=k; 
    kurirSel.appendChild(opt);
  });

  function refreshTanggalTukar(){
    const kurir = kurirSel.value;
    tanggalTukarSel.innerHTML='';
    // Tanggal tukar = tanggal dimana kurir pengganti sedang OFF
    jadwalData[ym].forEach(it=>{
      if(it.off===kurir){
        const opt = document.createElement('option'); 
        opt.value=it.tanggal; 
        opt.textContent=it.tanggal; 
        tanggalTukarSel.appendChild(opt);
      }
    });
    // Jika kosong, beri placeholder
    if(!tanggalTukarSel.children.length){
      const opt=document.createElement('option');
      opt.value=''; opt.textContent='(Kurir ini tidak punya OFF di bulan ini)'; 
      tanggalTukarSel.appendChild(opt);
    }
  }

  tanggalSel.onchange = refreshTanggalTukar;
  kurirSel.onchange = refreshTanggalTukar;
  refreshTanggalTukar();
}

// ===== Firestore I/O =====
async function saveFirestoreJadwal(ym){
  if(jadwalData[ym]) {
    await JADWAL_COLLECTION.doc(ym).set({data:jadwalData[ym]});
  }
}

async function saveKurirList(){
  await MASTER_DOC.set({kurirList,updated:new Date().toISOString()});
}

// ===== Realtime Listeners =====
function listenMasterKurir(){
  MASTER_DOC.onSnapshot(async doc=>{
    if(doc.exists){
      kurirList = Array.isArray(doc.data().kurirList) ? doc.data().kurirList : [];
      quickSync();
      setupFormPengajuan();
    }else{
      // Jika belum ada, biarkan fallback lokal tampil; admin bisa klik "Save" untuk membuatnya.
      quickSync();
      setupFormPengajuan();
    }
  });
}

function listenJadwal(ym){
  if(unsubJadwal) { unsubJadwal(); unsubJadwal=null; }
  unsubJadwal = JADWAL_COLLECTION.doc(ym).onSnapshot(async doc=>{
    if(doc.exists){
      jadwalData[ym] = doc.data().data || [];
      quickSync();
      setupFormPengajuan();
    }else{
      // jika dokumen bulan ini belum ada, buat berdasarkan kurirList yang ada
      generateFairOffForMonth(ym);
      await saveFirestoreJadwal(ym);
      popupShow(true,'Jadwal dibuat','Bulan '+ym);
    }
  });
}

function listenPengajuan(){
  PENGAJUAN_COLLECTION.orderBy('created','desc').onSnapshot(snap=>{
    pengajuanCache = [];
    snap.forEach(doc=>{
      const d = doc.data();
      pengajuanCache.push({ id: doc.id, ...d });
    });
    renderApproval();
  });
}

// ===== Tabs =====
document.querySelectorAll('.topbar .btn[data-tab]').forEach(b=>{ 
  b.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.topbar .btn[data-tab]').forEach(bb=>bb.classList.remove('active'));
    document.getElementById(b.dataset.tab).classList.add('active'); 
    b.classList.add('active');
  }
});

// ===== Admin Actions =====
document.getElementById('btn-add').onclick=async()=>{
  if(!isFirebaseAdmin) return alert('Admin saja.');
  const nama=prompt('Nama Kurir baru:'); 
  if(nama){ kurirList.push(nama.trim()); await saveKurirList(); popupShow(true,'Kurir ditambahkan',nama); }
};
document.getElementById('btn-del').onclick=async()=>{
  if(!isFirebaseAdmin) return alert('Admin saja.');
  const nama=prompt('Hapus kurir (ketik persis):'); 
  const idx=kurirList.indexOf(nama);
  if(idx>-1){ kurirList.splice(idx,1); await saveKurirList(); popupShow(true,'Kurir dihapus',nama); }
};
document.getElementById('btn-regen').onclick=async()=>{
  if(!isFirebaseAdmin) return alert('Admin saja.');
  const ym=document.getElementById('monthPick').value; 
  if(!ym) return; 
  generateFairOffForMonth(ym); 
  await saveFirestoreJadwal(ym);
  popupShow(true,'Regenerasi selesai',ym);
};
document.getElementById('btn-save').onclick=async()=>{
  if(!isFirebaseAdmin) return alert('Admin saja.');
  try{ 
    await saveKurirList();
    const ym=document.getElementById('monthPick').value;
    if(jadwalData[ym]) await saveFirestoreJadwal(ym);
    popupShow(true,'Data disimpan di Firestore'); 
  }catch(e){ popupShow(false,'Gagal save: '+e.message); }
};

// ===== Pengajuan Tukar =====
document.getElementById('btnAjukan').onclick = async()=>{
  const tanggal = document.getElementById('pengajuanTanggal').value;
  const pengganti = document.getElementById('penggantiKurir').value;
  const tukarTanggal = document.getElementById('tanggalTukar').value;
  if(!tanggal||!pengganti||!tukarTanggal) return alert('Pilih tanggal, kurir pengganti & tanggal tukar');

  const ym = tanggal.slice(0,7);
  const row = (jadwalData[ym]||[]).find(it=>it.tanggal===tanggal);
  if(!row || !row.off) return alert('Tidak ada kurir off pada tanggal ini');

  try{
    await PENGAJUAN_COLLECTION.add({
      tanggal,
      tukarTanggal,
      asal: row.off,
      pengganti,
      status: 'Pending',
      created: firebase.firestore.FieldValue.serverTimestamp(),
      uid: auth.currentUser ? auth.currentUser.uid : null,
      email: auth.currentUser ? auth.currentUser.email : null
    });
    popupShow('pending','Pengajuan terkirim','Tunggu approval admin');
  }catch(e){ alert('Gagal mengirim pengajuan: '+e.message); }
};

// ===== Firebase Login =====
document.getElementById('btn-login').onclick=()=>document.getElementById('overlay').style.display='flex';
document.getElementById('closeOverlay').onclick=()=>document.getElementById('overlay').style.display='none';
document.getElementById('doFirebaseLogin').onclick=async()=>{
  const email=document.getElementById('fbEmail').value.trim();
  const pass=document.getElementById('fbPass').value;
  if(!email||!pass) return alert('Masukkan email & password Firebase.');
  try{
    const cred=await auth.signInWithEmailAndPassword(email,pass);
    if(cred.user.uid===ADMIN_UID){
      isFirebaseAdmin=true; setAdminUI(true);
      document.getElementById('overlay').style.display='none';
      popupShow(true,'Login admin berhasil','Sekarang bisa Approve & Save');
    }else{ await auth.signOut(); alert('UID bukan admin.'); }
  }catch(err){ alert('Login Firebase gagal: '+(err.message||err)); console.error(err); }
};
document.getElementById('btn-logout').onclick=async()=>{
  try{ await auth.signOut(); }catch(e){}
  isFirebaseAdmin=false; setAdminUI(false); popupShow(true,'Logout berhasil');
};

function setAdminUI(show){
  document.getElementById('adminBar').style.display=show?'flex':'none';
  document.getElementById('btn-absensi-tab').style.display=show?'':'none';
  document.getElementById('btn-approval-tab').style.display=show?'':'none';
  document.getElementById('btn-login').style.display=show?'none':'';
  document.getElementById('btn-logout').style.display=show?'':'none';
  quickSync();
}

// ===== Init =====
const monthPick = document.getElementById('monthPick');
monthPick.value = new Date().toISOString().slice(0,7);

// Realtime master kurir & pengajuan (sekali di-init)
listenMasterKurir();
listenPengajuan();

// Listener jadwal per-bulan (ubah saat monthPick berubah)
listenJadwal(monthPick.value);
monthPick.onchange = ()=> listenJadwal(monthPick.value);
</script>
</body>
</html>
