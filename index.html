<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sahabatku Delivery ‚Äî Firebase</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
  --sky-light: #00CAFF;
  --sky: #00CAFF;
  --sky-strong: #00CAFF;
  --accent: #0077c8;
  --muted: #4a6fa5;
  --card-bg: #ffffff;
  --glass: rgba(255, 255, 255, 0.85);
  --border: #c9dbf8;
  --shadow-light: rgba(74, 144, 226, 0.15);
  --shadow-strong: rgba(74, 144, 226, 0.3);
  --text-primary: #0b3b5a;
  --text-secondary: #506273;
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: 'Inter', system-ui, Arial, Helvetica, sans-serif;
  background: linear-gradient(180deg, var(--sky-light) 0%, var(--sky) 70%);
  color: var(--text-primary);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;

}

.container {
  max-width: 960px;
  margin: 24px auto;
  padding: 16px 20px;
}

.card {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 24px 28px;
  box-shadow: 0 12px 30px var(--shadow-light);
  margin-bottom: 20px;
  border: 1px solid var(--border);
  transition: box-shadow 0.3s ease;
}

.card:hover {
  box-shadow: 0 16px 40px var(--shadow-strong);
}

h2, h3 {
  margin: 8px 0 16px 0;
  color: var(--sky-strong);
  font-weight: 700;
  letter-spacing: 0.02em;
}

label {
  display: block;
  margin-top: 12px;
  font-size: 14px;
  color: var(--muted);
  font-weight: 600;
  letter-spacing: 0.01em;
}

input[type="text"],
input[type="password"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 14px 16px;
  border-radius: 14px;
  border: 1.5px solid var(--border);
  margin-top: 8px;
  background: var(--glass);
  outline: none;
  font-size: 1rem;
  color: var(--text-primary);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

input[type="text"]:focus,
input[type="password"]:focus,
input[type="number"]:focus,
textarea:focus,
select:focus {
  border-color: var(--sky-strong);
  box-shadow: 0 0 8px var(--sky-strong);
  background: #f0f8ff;
}
/* Posisi pojok kanan atas */
#btnLogout {
  position: fixed;       /* selalu di atas */
  top: 20px;
  right: 20px;
  padding: 8px 14px;
  font-size: 0.85rem;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  background: linear-gradient(45deg, #ff4b2b, #ff416c);
  color: white;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
  z-index: 1000;
}

/* Hover efek animasi keren */
#btnLogout:hover {
  transform: scale(1.1) rotate(-3deg);
  box-shadow: 0 6px 25px rgba(255,65,108,0.6);
  background: linear-gradient(45deg, #ff416c, #ff4b2b);
  text-shadow: 0 0 5px #fff;
}

/* Saat ditekan */
#btnLogout:active {
  transform: scale(0.95) rotate(0deg);
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

.btn {
  background: var(--sky-strong);
  color: white;
  border: none;
  padding: 14px 20px;
  border-radius: 16px;
  cursor: pointer;
  box-shadow: 0 8px 24px var(--shadow-light);
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.02em;
  transition: background 0.3s ease, box-shadow 0.3s ease;
}
.btnbar {
  display: flex;
  justify-content: flex-end; /* rata kanan */
  gap: 10px; /* jarak antar tombol */
  margin-top: 10px;
}

.btn:hover {
  background: #3a6fc1;
  box-shadow: 0 10px 30px var(--shadow-strong);
}

.btn.secondary {
  background: #f5f7fa;
  color: var(--text-primary);
  border: 1.5px solid var(--border);
  box-shadow: none;
  font-weight: 600;
}

.btn.secondary:hover {
  background: #e1e9f8;
  border-color: var(--sky-strong);
  color: var(--sky-strong);
}

.btn.ghost {
  background: transparent;
  color: var(--text-primary);
  border: 1.5px dashed var(--border);
  font-weight: 600;
}

.btn.ghost:hover {
  border-color: var(--sky-strong);
  color: var(--sky-strong);
}

.btn.danger {
  background: #ff6b6b;
  box-shadow: none;
  font-weight: 700;
  transition: background 0.3s ease;
}

.btn.danger:hover {
  background: #e04e4e;
}

.btn.full {
  width: 100%;
}

.btnbar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

nav.tab {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}

nav.tab button {
  padding: 14px 0;
  border-radius: 16px;
  border: 1.5px solid var(--border);
  background: var(--card-bg);
  color: var(--text-primary);
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.02em;
  transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  cursor: pointer;
}

nav.tab button.active {
  background: linear-gradient(90deg, var(--sky-strong), #6fc2ff);
  color: white;
  border-color: transparent;
  box-shadow: 0 8px 24px var(--shadow-light);
}

.row {
  display: flex;
  gap: 16px;
  align-items: flex-start;
}

.col {
  flex: 1;
}

.hidden {
  display: none;
}

.small {
  font-size: 13px;
  color: var(--muted);
  font-weight: 600;
}

.stack {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.grid {
  display: grid;
  gap: 16px;
}

.grid-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-3 {
  grid-template-columns: repeat(3, 1fr);
}

.grid-4 {
  grid-template-columns: repeat(4, 1fr);
}

.section-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  font-weight: 700;
  color: var(--sky-strong);
  font-size: 1.1rem;
}

.list-v {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Item & Tambahan cards sejajar */
.line-card {
  border: 1.5px solid var(--border);
  border-radius: 18px;
  background: var(--card-bg);
  padding: 14px 18px;
  display: grid;
  grid-template-columns: 2.5fr 90px 180px 130px 100px;
  gap: 12px;
  align-items: center;
  box-shadow: 0 4px 12px rgba(74, 144, 226, 0.07);
  transition: box-shadow 0.3s ease;
}

.line-card:hover {
  box-shadow: 0 8px 24px var(--shadow-light);
}

.line-card .sub {
  font-weight: 700;
  text-align: center;
  color: var(--sky-strong);
  font-size: 0.95rem;
}

.line-card .mini-btn {
  width: 100%;
  border-radius: 14px;
  padding: 8px 0;
  font-weight: 600;
  font-size: 0.9rem;
  background: var(--sky);
  color: var(--text-primary);
  border: none;
  cursor: pointer;
  transition: background 0.3s ease;
}

.line-card .mini-btn:hover {
  background: var(--sky-strong);
  color: white;
}

/* Tambahan card */
.line-card-tambahan {
  border: 1.5px solid var(--border);
  border-radius: 18px;
  background: var(--card-bg);
  padding: 14px 18px;
  display: grid;
  grid-template-columns: 1.8fr 1.2fr 130px;
  gap: 12px;
  align-items: center;
  box-shadow: 0 4px 12px rgba(74, 144, 226, 0.07);
  transition: box-shadow 0.3s ease;
}

.line-card-tambahan:hover {
  box-shadow: 0 8px 24px var(--shadow-light);
}

/* Nota Preview */
.nota-box {
  white-space: pre-wrap;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  background: #f5faff;
  padding: 20px 24px;
  border-radius: 16px;
  border: 1.5px solid #c9dbf8;
  min-height: 160px;
  color: var(--text-primary);
  font-size: 0.95rem;
  box-shadow: inset 0 0 10px #dbeeff;
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95rem;
  color: var(--text-primary);
}

th, td {
  padding: 14px 12px;
  border: 1.5px solid var(--border);
  text-align: center;
  font-weight: 600;
}

th {
  background: linear-gradient(90deg, var(--sky-strong), #6fc2ff);
  color: white;
  letter-spacing: 0.03em;
}
.grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.input-wrap { position:relative; margin-bottom:20px; }
select, input {
  width:100%; padding:8px; margin-top:4px;
  border:1px solid #ccc; border-radius:6px;
}
.suggest {
  position:absolute;
  top:100%; left:0; right:0;
  background:#fff;
  border:1px solid #ccc;
  max-height:200px;
  overflow-y:auto;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  z-index:1000;

  /* animasi */
  opacity:0;
  transform:scale(0.95);
  height:0;
  transition: all 0.25s ease;
  pointer-events:none;
}

.suggest.show {
  opacity:1;
  transform:scale(1);
  height:auto;
  pointer-events:auto;
}

.s-item {
  padding:5px 8px;
  cursor:pointer;
  font-size:14px;
}
.s-item:hover {
  background:#f5f5f5;
}

}
.s-item { padding:6px 10px; cursor:pointer; }
.s-item:hover { background:#f0f0f0; }
.harga { font-size:20px; font-weight:bold; margin-top:4px; }


/* Mobile tweaks */
@media (max-width: 900px) {
  nav.tab {
    grid-template-columns: repeat(2, 1fr);
  }
  .grid-3 {
    grid-template-columns: 1fr;
  }
  .line-card {
    grid-template-columns: 1fr 90px 140px 120px 90px;
  }
  .line-card-tambahan {
    grid-template-columns: 1fr 1.2fr 120px;
  }
}
.input-wrap { position: relative; }
.suggest {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ccc;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  border-radius: 6px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.s-item {
  padding: 6px 10px;
  cursor: pointer;
}
.s-item:hover {
  background: #f0f0f0;
}

@media (max-width: 600px) {
  .line-card {
    grid-template-columns: 4fr 70px 90px 100px;
  }
  .line-card-tambahan {
    grid-template-columns: 1fr 1fr 90px;
  }
}
/* Penyesuaian khusus untuk layar kecil (HP) */
@media (max-width: 600px) {
  /* Container lebih sempit dan padding lebih kecil */
  .container {
    padding: 12px 16px;
    margin: 16px auto;
  }

  /* Header font lebih kecil dan padding lebih ringkas */
  header {
    padding: 14px 16px;
    font-size: 1.1rem;
  }

  /* Judul header lebih ringkas */
  header .title {
    font-size: 1.3rem;
  }

  /* Grid dan layout line-card disesuaikan agar lebih simpel */
  .line-card {
    grid-template-columns: 3fr 60px 70px 80px;
    padding: 12px 14px;
    gap: 8px;
  }

  .line-card-tambahan {
    grid-template-columns: 1.5fr 1fr 80px;
    padding: 12px 14px;
    gap: 8px;
  }

  /* Font dan padding lebih kecil untuk teks dan tombol mini */
  .line-card .sub {
    font-size: 0.85rem;
  }

  .line-card .mini-btn {
    font-size: 0.8rem;
    padding: 6px 0;
    border-radius: 12px;
  }

  /* Nota box padding dan font lebih kecil */
  .nota-box {
    padding: 16px 18px;
    font-size: 0.85rem;
    min-height: 120px;
  }

  /* Table font lebih kecil dan padding ringkas */
  table {
    font-size: 0.85rem;
  }

  th, td {
    padding: 10px 8px;
  }

  /* Nav tab jadi 2 kolom */
  nav.tab {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  nav.tab button {
    padding: 10px 0;
    font-size: 0.9rem;
    border-radius: 14px;
  }

  /* Tombol utama dan sekunder melebar penuh */
  .btn.full {
    width: 100%;
  }

  /* Input, select, textarea padding lebih kecil */
  input[type="text"],
  input[type="password"],
  input[type="number"],
  textarea,
  select {
    padding: 10px 12px;
    font-size: 0.9rem;
    border-radius: 12px;
  }

  /* Stack dan grid gap lebih kecil */
  .stack {
    gap: 8px;
  }

  .grid {
    gap: 8px;
  }

  /* Row jadi kolom vertikal */
  .row {
    flex-direction: column;
    gap: 12px;
  }

  /* Tombol bar jadi kolom vertikal */
  .btnbar {
    flex-direction: column;
    gap: 12px;
  }

  /* Section title font lebih kecil */
  .section-title {
    font-size: 1rem;
    margin-top: 8px;
  }

  /* Small text lebih kecil dan rapat */
  .small {
    font-size: 11px;
    margin-top: 6px;
  }
}

    }
  </style>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login Kurir</h2>
    <div class="grid grid-3">
      <div>
        <label>Username</label>
        <input id="loginUser" type="text" placeholder="Nama kurir (contoh: Tom Haye)" autocomplete="username">
      </div>
      <div>
        <label>Password</label>
        <input id="loginPass" type="password" placeholder="ID Card (contoh: A1234)" autocomplete="current-password">
      </div>
      <div style="align-self:end">
        <div class="btnbar">
          <button id="btnLogin" class="btn">Masuk</button>
        </div>
      </div>
    </div>
    <p id="loginMsg" class="small" style="color:#c0392b;margin-top:8px"></p>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div>
          <h2>Halo, <span id="curUser" style="color:#0b4870;font-weight:800"></span></h2>
          <div class="small">Buat nota ‚Ä¢ Simpan Nota ‚Ä¢ Rekap bulanan ‚Ä¢ Pelacak ‚Ä¢ Cek Ongkir</div>
        </div>
        <div>
          <div class="small">No Nota berikutnya:</div>
          <div id="nextNota" style="font-weight:800;font-size:18px;color:#0b4870">-</div>
        </div>
          <button id="btnLogout" class="btn danger hidden">Logout</button>

      </div>
    </div>

    <div class="card">
      <nav class="tab" id="tabNav">
        <button data-tab="notaTab" class="active">üìù Nota</button>
        <button data-tab="riwayatTab">üìë Riwayat</button>
        <button data-tab="rekapTab">üìä Rekap</button>
        <button data-tab="pelacakTab">üìã Pelacak</button>
        <button data-tab="ongkirTab">üìç Cek Ongkir</button>
        <button data-tab="pengaturanTab">‚öôÔ∏è Pengaturan</button>
        <button onclick="window.location.href='absensi-kurir-sahabatku.html'">‚úÖ Absensi Kurir</button>


      </nav>
      

  </div>

    <!-- NOTA TAB -->
      <div id="notaTab" class="tabContent">
        <h3>Buat / Edit Nota</h3>

        <div class="grid grid-3">
          <div>
            <label>Nama Kurir</label>
            <input id="kurirName" type="text" readonly>
          </div>
          <div>
            <label>Nomor WhatsApp Customer</label>
            <input id="custPhone" type="text" placeholder="6281234... (opsional)">
          </div>
          <div>
            <label>Ongkir (Rp)</label>
            <input id="ongkir" type="number" value="0" min="0">
          </div>
        </div>

        <div class="section-title" style="margin-top:14px">
          <div class="small" style="font-weight:700">Daftar Item</div>
          <div class="btnbar">
            <button id="btnAddItem" class="btn">+ Item</button>
            <button id="btnClearItems" class="btn secondary">Bersihkan</button>
          </div>
        </div>

        <div id="itemsArea" class="list-v" style="margin-top:10px"></div>

        <div class="section-title" style="margin-top:14px">
          <div class="small" style="font-weight:700">Tambahan Biaya</div>
          <div class="btnbar">
            <button id="btnAddTambahan" class="btn secondary">+ Tambahan</button>
          </div>
        </div>
        <div id="tambahanArea" class="list-v" style="margin-top:10px"></div>

        <div class="grid grid-3" style="margin-top:8px;align-items:end">
          <div>
            <label>Total</label>
            <div id="totalPesanan" style="font-weight:800;font-size:22px;color:#FFF4A4">Rp 0</div>
            <div class="small">Subtotal item + ongkir + tambahan</div>
          </div>
          <div></div>
        <div class="btnbar" style="justify-content:flex-end">
          <button id="btnSaveForm" class="btn secondary">Simpan Nota</button>
          <button id="btnExportPreview" class="btn secondary">Simpan Foto</button>
          <button id="btnSharePreview" class="btn secondary">Bagikan WhatsApp</button>
          <button id="btnClearAll" class="btn danger">Bersihkan Semua</button>

        </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title">
            <h3 style="margin:0">Preview Nota</h3>
            <div class="small">Nama file: <span id="previewFilename">-</span></div>
          </div>
          <div id="notaPreview" class="nota-box">Belum ada nota.</div>
        </div>
      </div>

      <!-- RIWAYAT TAB -->
      <div id="riwayatTab" class="tabContent hidden">
        <h3>Riwayat Nota (akun ini)</h3>
        <div id="notaHistory"></div>
      </div>

      <!-- REKAP TAB -->
      <div id="rekapTab" class="tabContent hidden">
        <h3>Rekap Bulanan</h3>
        <div class="grid grid-3">
          <div>
            <label>Bulan</label>
            <input id="rekapMonth" type="month">
          </div>
          <div style="align-self:end">
            <button id="btnLoadRekap" class="btn">Muat Rekap</button>
          </div>
        </div>
        <div class="card" style="margin-top:10px">
          <table aria-label="Rekap Bulanan">
            <thead><tr><th>Tanggal</th><th>Jumlah Nota</th><th>Ongkir</th><th>Tambahan</th><th>Total</th></tr></thead>
            <tbody id="rekapBody"></tbody>
            <tfoot><tr><th>Total Bulan</th><th id="sumNota">0</th><th id="sumOngkir">0</th><th id="sumTambahan">0</th><th id="sumTotal">0</th></tr></tfoot>
          </table>
        </div>
      </div>

      <!-- PELACAK TAB -->
      <div id="pelacakTab" class="tabContent hidden">
        <h3>Pelacak Orderan</h3>
        <div class="grid grid-3">
          <div>
            <label>No Nota</label>
            <input id="trackNoNota" type="text" placeholder="cth: 00012">
          </div>
          <div>
            <label>Tanggal (YYYY-MM-DD)</label>
            <input id="trackDate" type="text" placeholder="2025-09-01">
          </div>
          <div style="align-self:end">
            <div class="btnbar">
              <button id="btnCariNota" class="btn">Cari</button>
              <button id="btnCariReset" class="btn secondary">Reset</button>
            </div>
          </div>
        </div>
        <div id="pelacakHasil" style="margin-top:10px"></div>
      </div>
      
      <!-- ONGKIR TAB -->
      <div id="ongkirTab" class="tabContent hidden">
        <h3>Cek Ongkir</h3>
        <div class="grid">
          <!-- ASAL -->
          <div>
            <label>Asal (opsional)</label>
            <select id="asalSelect"></select>
            <input id="asalInput" type="text" placeholder="Ketik lokasi asal‚Ä¶ (opsional)">
            <div class="suggest" id="asalSuggest"></div>
          </div>
          <!-- TUJUAN -->
          <div>
            <label>Tujuan</label>
            <select id="tujuanSelect"></select>
            <input id="tujuanInput" type="text" placeholder="Ketik lokasi tujuan‚Ä¶">
            <div class="suggest" id="tujuanSuggest"></div>
          </div>
        </div>

        <div class="btnbar">
          <button id="cekBtn" class="btn primary">Cek Ongkir</button>
          <button id="bersihkanBtn" class="btn secondary">Bersihkan</button>
        </div>
        
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <span class="small">Isi salah satu = ongkir normal</span>
          <span class="small">Isi dua-duanya = (Asal + Tujuan) ‚àí 6.000</span>
        </div>
        
        <div class="results" id="results">
          <div class="card">
            <h4>Ongkir Normal</h4>
            <div class="harga" id="normalHarga">‚Äì</div>
            <div class="small" id="normalKeterangan">‚Äî</div>
          </div>
          <div class="card">
            <h4>Ongkir Rute</h4>
            <div class="harga" id="ruteHarga">‚Äì</div>
            <div class="small" id="ruteKeterangan">‚Äî</div>
            <div class="small" id="ruteFormula" style="display:none"></div>
          </div>
        </div>
      </div>

    <div id="pengaturanTab" class="tabContent hidden">
        <h3>Pengaturan Akun</h3>
        <p class="small" style="margin-top:-8px; margin-bottom:12px;">Ubah username dan password Anda. Username baru akan menjadi nama kurir baru Anda di sistem.</p>
        <div class="card">
            <div class="stack">
                <div>
                </div>
                <div>
                    <label>Password Baru</label>
                    <input id="newPassword" type="password" placeholder="Masukkan password baru">
                </div>
                <div>
                    <label>Konfirmasi Password Baru</label>
                    <input id="confirmPassword" type="password" placeholder="Ketik ulang password baru">
                </div>
                <div class="btnbar">
                    <button id="btnUpdateProfile" class="btn full">Simpan Perubahan</button>
                </div>
            </div>
        </div>
        <p id="profileUpdateMsg" class="small" style="color:#2ecc71;margin-top:8px"></p>
    </div>
  </div>
</div>


<!-- Firebase SDK (ESM) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getDatabase, ref, set, get, onValue, update, remove, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getAuth, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js"; // Import Firebase Auth


  // === CONFIG DARI KAMU ===
  const firebaseConfig = {
    apiKey: "AIzaSyCtva8TeL40-WotK4kFL_vL8uUXL3GDfww",
    authDomain: "sahabatkuu-bisa.firebaseapp.com",
    databaseURL: "https://sahabatkuu-bisa-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sahabatkuu-bisa",
    storageBucket: "sahabatkuu-bisa.firebasestorage.app",
    messagingSenderId: "315555564115",
    appId: "1:315555564115:web:56f46dbceb8c154589d4a6",
    measurementId: "G-PFGYL96VPS"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}

  // Realtime DB
  const db = getDatabase(app);

  /* ===================
     Login Dummy
  ====================*/
  const sampleUsers = {
  };
  let currentUser = null;
  let lastNoNota = 0;   // cache untuk tampilkan next number
  let notaCounterLoaded = false;

  const el = (id)=>document.getElementById(id);
  const qs = (sel)=>document.querySelector(sel);
  const qsa = (sel)=>Array.from(document.querySelectorAll(sel));

  // UI helpers
  function setActiveTab(id){
    qsa('nav#tabNav button').forEach(b=>{
      b.classList.toggle('active', b.dataset.tab===id);
    });
    qsa('.tabContent').forEach(t=> t.classList.add('hidden'));
    el(id).classList.remove('hidden');
    if(id==='riwayatTab') refreshNotaHistory();
    if(id==='pengaturanTab') el('newUsername').value = currentUser; 
  }

  // LOGIN
  el('btnLogin').addEventListener('click', doLogin);
  el('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('currentUser'); location.reload(); });
  qsa('nav#tabNav button').forEach(b=> b.addEventListener('click', ()=> setActiveTab(b.dataset.tab)));
// === FUNGSI UTAMA UNTUK UPDATE PASSWORD SAJA ===
  el('btnUpdateProfile').addEventListener('click', async () => {
      const newPassword = el('newPassword').value.trim();
      const confirmPassword = el('confirmPassword').value.trim();
      const msg = el('profileUpdateMsg');
      
      msg.innerText = '';
      msg.style.color = '#2ecc71';

      if (!newPassword || !confirmPassword) {
          msg.innerText = 'Semua field harus diisi.';
          msg.style.color = '#c0392b';
          return;
      }
      
      if (newPassword !== confirmPassword) {
          msg.innerText = 'Password baru tidak cocok.';
          msg.style.color = '#c0392b';
          return;
      }

      try {
          // Menggunakan `update()` untuk memperbarui password di Firebase Realtime Database
          const updates = {};
          updates['/kurir/' + currentUser + '/password'] = newPassword;
          await update(ref(db), updates);

          // Notifikasi pop-up saat berhasil
          alert('Password berhasil diperbarui!');
          el('newPassword').value = '';
          el('confirmPassword').value = '';
          msg.innerText = ''; // Kosongkan pesan teks
      } catch (error) {
          console.error("Error updating password:", error);
          // Notifikasi pop-up saat gagal
          alert('Gagal memperbarui password: ' + error.message);
          msg.innerText = ''; // Kosongkan pesan teks
      }
  });
  async function doLogin(){
    const u = el('loginUser').value.trim();
    const p = el('loginPass').value.trim();
  
    // 1Ô∏è‚É£ Cek sampleUsers (dummy)
    if(u && sampleUsers[u]===p){
      return loginSuccess(u);
    }
  
    // 2Ô∏è‚É£ Cek di Firebase Realtime Database (kurir/{username})
    try {
      const snap = await get(ref(db, 'kurir/' + u));
      if(snap.exists()){
        const data = snap.val();
        if(!data.enabled){
          el('loginMsg').innerText = 'Akun ini dinonaktifkan!';
          return;
        }
        if(data.password !== p){
          el('loginMsg').innerText = 'Password salah!';
          return;
        }
        return loginSuccess(data.username);
      } else {
        el('loginMsg').innerText = 'User tidak ditemukan di Firebase!';
      }
    } catch(err){
      console.error("Firebase error:", err);
      el('loginMsg').innerText = 'Gagal konek Firebase!';
    }
  }
  
  // üîπ Helper untuk login sukses
  function loginSuccess(username){
    currentUser = username;
    localStorage.setItem('currentUser', username);
    el('loginCard').classList.add('hidden');
    el('app').classList.remove('hidden');
    el('btnLogout').classList.remove('hidden');
    el('curUser').innerText = currentUser;
    el('kurirName').value = currentUser;
    setActiveTab('notaTab');
    ensureCounter().then(updateNextNotaLabel);
    refreshNotaHistory();
  }

  window.addEventListener('load', async ()=>{
    const savedUser = localStorage.getItem('currentUser');
    if(savedUser){
      try {
        // Cek di Firebase Realtime DB
        const snap = await get(ref(db, 'kurir/' + savedUser));
        if(snap.exists() && snap.val().enabled){
          loginSuccess(savedUser);
        } else {
          localStorage.removeItem('currentUser');
        }
      } catch(err){
        console.error("Firebase error:", err);
        localStorage.removeItem('currentUser');
      }
    }
const formatRp = n => "Rp " + (n || 0).toLocaleString("id-ID");
let ongkirData = [];

// üîπ Ambil data ongkir dari Firebase
async function loadOngkir(){
  const snapshot = await get(child(ref(db), "daftar_ongkir"));
  if(snapshot.exists()){
    const val = snapshot.val();
    ongkirData = Object.keys(val).map(key => ({
      lokasi: String(val[key].wilayah).trim(),
      ongkir: Number(val[key].ongkir) || 0
    }));
    console.log("‚úÖ Data Firebase:", ongkirData);
    fillSelect("asalSelect", ongkirData);
    fillSelect("tujuanSelect", ongkirData);
  }
}

function fillSelect(selectId, data){
  const sel = document.getElementById(selectId);
  sel.innerHTML = `<option value="">-- Pilih --</option>`;
  data.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = o.lokasi;
    opt.textContent = `${o.lokasi} (Rp ${o.ongkir.toLocaleString("id-ID")})`;
    sel.appendChild(opt);
  });
}

function showSuggestions(input, suggestBox) {
  const val = input.value.toLowerCase();
  suggestBox.innerHTML = "";
  suggestBox.classList.remove("show"); // sembunyikan dulu

  if (!val) return;

  const filtered = ongkirData.filter(o => o.lokasi.toLowerCase().includes(val));
  if(filtered.length === 0){
    suggestBox.innerHTML = "<div class='s-item' style='color:#888'>Tidak ditemukan</div>";
    suggestBox.classList.add("show");
    return;
  }

  filtered.forEach(o=>{
    const div=document.createElement("div");
    div.className="s-item";
    div.textContent = `${o.lokasi} (Rp ${o.ongkir})`;
    div.onclick=()=>{
      input.value = o.lokasi;
      suggestBox.innerHTML="";
      suggestBox.classList.remove("show");
    };
    suggestBox.appendChild(div);
  });

  suggestBox.classList.add("show"); // tampil dengan animasi
}

function findByName(name){
  if(!name) return null;
  const clean = name.trim().toLowerCase();
  return ongkirData.find(o => o.lokasi.trim().toLowerCase() === clean) || null;
}

function hitung(){
  const asalVal   = document.getElementById("asalInput").value.trim();
  const asalSel   = document.getElementById("asalSelect").value;
  const tujuanVal = document.getElementById("tujuanInput").value.trim();
  const tujuanSel = document.getElementById("tujuanSelect").value;

  const asal   = asalVal ? findByName(asalVal) : findByName(asalSel);
  const tujuan = tujuanVal ? findByName(tujuanVal) : findByName(tujuanSel);

  const normalHarga = document.getElementById("normalHarga");
  const normalKet   = document.getElementById("normalKeterangan");
  const ruteHarga   = document.getElementById("ruteHarga");
  const ruteKet     = document.getElementById("ruteKeterangan");
  const ruteFormula = document.getElementById("ruteFormula");

  if(tujuan){
    normalHarga.innerText = formatRp(tujuan.ongkir);
    normalKet.innerText = "Tujuan: " + tujuan.lokasi;
  } else if(asal){
    normalHarga.innerText = formatRp(asal.ongkir);
    normalKet.innerText = "Asal: " + asal.lokasi;
  } else {
    normalHarga.innerText = "‚Äì";
    normalKet.innerText = "Lokasi tidak ditemukan";
  }

  if(asal && tujuan){
    if(asal.lokasi === tujuan.lokasi){
      ruteHarga.innerText = "‚Äì";
      ruteKet.innerText = "Asal & tujuan sama ‚Üí ongkir normal saja";
      ruteFormula.style.display="none";
      return;
    }
    const total = (asal.ongkir + tujuan.ongkir) - 6000;
    ruteHarga.innerText = formatRp(total);
    ruteKet.innerText = `${asal.lokasi} + ${tujuan.lokasi} - Rp6.000`;
    ruteFormula.style.display="block";
    ruteFormula.innerText = `(${asal.ongkir} + ${tujuan.ongkir}) - 6000 = ${total}`;
  } else {
    ruteHarga.innerText = "‚Äì";
    ruteKet.innerText = "Isi asal & tujuan untuk ongkir rute";
    ruteFormula.style.display="none";
  }
}

// üîπ Event
document.getElementById("asalInput").addEventListener("input", ()=> showSuggestions(
  document.getElementById("asalInput"), document.getElementById("asalSuggest")
));
document.getElementById("tujuanInput").addEventListener("input", ()=> showSuggestions(
  document.getElementById("tujuanInput"), document.getElementById("tujuanSuggest")
));

document.getElementById("asalSelect").addEventListener("change", ()=> document.getElementById("asalInput").value = document.getElementById("asalSelect").value);
document.getElementById("tujuanSelect").addEventListener("change", ()=> document.getElementById("tujuanInput").value = document.getElementById("tujuanSelect").value);

document.getElementById("cekBtn").addEventListener("click", hitung);

document.getElementById("bersihkanBtn").addEventListener("click", ()=>{
  document.getElementById("asalInput").value="";
  document.getElementById("asalSelect").value="";
  document.getElementById("tujuanInput").value="";
  document.getElementById("tujuanSelect").value="";
  document.getElementById("asalSuggest").innerHTML="";
  document.getElementById("tujuanSuggest").innerHTML="";
  document.getElementById("normalHarga").innerText="‚Äì";
  document.getElementById("normalKeterangan").innerText="‚Äî";
  document.getElementById("ruteHarga").innerText="‚Äì";
  document.getElementById("ruteKeterangan").innerText="‚Äî";
  document.getElementById("ruteFormula").style.display="none";
});

document.addEventListener("click",(e)=>{
  if(!e.target.closest(".suggest") && !e.target.closest("input")){
    document.getElementById("asalSuggest").innerHTML="";
    document.getElementById("tujuanSuggest").innerHTML="";
  }
});

// üîπ Load data saat awal
loadOngkir();
  });

  /* ===================
     Nota: UI Items & Tambahan
  ====================*/
  const itemsArea = el('itemsArea');
  const tambahanArea = el('tambahanArea');

  el('btnAddItem').addEventListener('click', ()=>addItemUI());
  el('btnClearItems').addEventListener('click', ()=>{ itemsArea.innerHTML=''; addItemUI(); updateTotals(); });
  el('btnAddTambahan').addEventListener('click', ()=> addTambahanUI());
  el('btnClearAll').addEventListener('click', () => {
  if(!confirm('Bersihkan semua form nota?')) return;
  // Hapus semua item & tambahan
  itemsArea.innerHTML = '';
  tambahanArea.innerHTML = '';

  // Tambah satu baris default masing-masing
  addItemUI();
  addTambahanUI();

  // Reset input lain
  el('ongkir').value = 0;
  el('custPhone').value = '';

  // Reset total & preview
  updateTotals();
  el('notaPreview').innerText = 'Belum ada nota.';
});

  el('ongkir').addEventListener('input', updateTotals);

  el('btnSaveForm').addEventListener('click', saveNoteToFirebase);
  el('btnExportPreview').addEventListener('click', savePreviewAsImage);
  el('btnSharePreview').addEventListener('click', sharePreviewImage);

  // Default satu baris item + satu baris tambahan di awal
  addItemUI();
  addTambahanUI();

  function addItemUI(pref={}){
    const wrap = document.createElement('div');
    wrap.className = 'line-card';
    wrap.innerHTML = `
      <div>
        <label class="small">Nama Item</label>
        <input class="iname" type="text" value="${pref.name||''}" placeholder="Nama menu / barang">
      </div>
      <div>
        <label class="small">Qty</label>
        <input class="iqty" type="number" min="1" value="${pref.qty||1}">
      </div>
      <div>
        <label class="small">Harga (Rp)</label>
        <input class="iprice" type="number" min="0" value="${pref.price||0}">
      </div>
      <div>
        <label class="small">Subtotal</label>
        <div class="sub isub">0</div>
      </div>
      <div>
        <button class="btn danger mini-btn removeBtn">Hapus</button>
      </div>
    `;
    itemsArea.appendChild(wrap);
    wrap.querySelectorAll('input').forEach(i=> i.addEventListener('input', updateTotals));
    wrap.querySelector('.removeBtn').addEventListener('click', ()=>{ wrap.remove(); updateTotals(); });
    updateTotals();
  }

  function addTambahanUI(pref={}){
    const row = document.createElement('div');
    row.className = 'line-card-tambahan';
    row.innerHTML = `
      <div>
        <label class="small">Jenis Tambahan</label>
        <select class="t-type">
      <option ${!pref.type?'selected':''} value="">-- Pilih --</option>
      <option ${pref.type==='Tambahan Ojeg'?'selected':''} value="Tambahan Ojeg">Tambahan Ojeg</option>
      <option ${pref.type==='Tambahan Malam'?'selected':''} value="Tambahan Malam">Tambahan Malam</option>
      <option ${pref.type==='Tambahan Tempat'?'selected':''} value="Tambahan Tempat">Tambahan Tempat</option>
      <option ${pref.type==='Tambahan Hujan'?'selected':''} value="Tambahan Hujan">Tambahan Hujan</option>
      <option ${pref.type==='Tambahan Parkir'?'selected':''} value="Tambahan Parkir">Tambahan Parkir</option>
      <option ${pref.type==='Tambahan Melebihi Kapasitas'?'selected':''} value="Tambahan Melebihi Kapasitas">Tambahan Melebihi Kapasitas</option>
      <option ${pref.type==='Tambahan Cash Minuman'?'selected':''} value="Tambahan Cash Minuman">Tambahan Cash Minuman</option>
      <option ${pref.type==='Lainnya'?'selected':''} value="Lainnya">Lainnya</option>
        </select>
      </div>
      <div>
        <label class="small">Nominal (Rp)</label>
        <input class="t-nom" type="number" min="0" value="${pref.nominal||0}">
      </div>
      <div>
        <button class="btn secondary mini-btn t-remove">Hapus</button>
      </div>
    `;
    tambahanArea.appendChild(row);
    row.querySelector('.t-nom').addEventListener('input', updateTotals);
    row.querySelector('.t-type').addEventListener('change', updateTotals);
    row.querySelector('.t-remove').addEventListener('click', ()=>{ row.remove(); updateTotals(); });
    updateTotals();
  }

  function updateTotals(){
    let total = 0;
    itemsArea.querySelectorAll('.line-card').forEach(c=>{
      const qty = Number(c.querySelector('.iqty').value)||0;
      const price = Number(c.querySelector('.iprice').value)||0;
      const sub = qty*price;
      c.querySelector('.isub').innerText = sub.toLocaleString('id-ID');
      total += sub;
    });
    const ong = Number(el('ongkir').value)||0; total += ong;
    let t = 0;
    tambahanArea.querySelectorAll('.t-nom').forEach(n=> t += Number(n.value)||0);
    total += t;
    el('totalPesanan').innerText = 'Rp ' + total.toLocaleString('id-ID');
    updatePreviewFilename();
    return total;
  }

  function leftPad(num, len=5){
    return String(num).padStart(len,'0');
  }

  function updatePreviewFilename(){
    const noNota = leftPad((lastNoNota||0)+1);
    const filename = `${currentUser||'User'}_nota_${noNota}.jpg`;
    el('previewFilename').innerText = filename;
    return filename;
  }

  function buildNotaObject(){
    // Items
    const items = []; let subtotal=0;
    itemsArea.querySelectorAll('.line-card').forEach((c,i)=>{
      const name = (c.querySelector('.iname').value||'').trim();
      const qty = Number(c.querySelector('.iqty').value)||0;
      const price = Number(c.querySelector('.iprice').value)||0;
      const sub = qty*price; subtotal += sub;
      items.push({name, qty, price, subtotal: sub});
    });
    // Tambahan
    const tambahans=[]; let tambahTotal=0;
    tambahanArea.querySelectorAll('.line-card-tambahan').forEach(r=>{
      const type=(r.querySelector('.t-type').value||'').trim();
      const nominal=Number(r.querySelector('.t-nom').value)||0;
      if(type || nominal) tambahans.push({type, nominal});
      tambahTotal += nominal;
    });

    const ongkir = Number(el('ongkir').value)||0;
    const custPhone=(el('custPhone').value||'').replace(/\D/g,'');
    const kurir = currentUser || '';

    const total = subtotal + ongkir + tambahTotal;
    const noNota = leftPad((lastNoNota||0)+1);
    const createdAt = new Date().toISOString();

    // Text nota
    const lines = [];
    lines.push('üßæ NOTA SAHABATKU DELIVERY');
    lines.push('==========================');
    lines.push(`Kurir : ${kurir}`);
    lines.push(`No    : ${noNota}`);
    lines.push(`Tanggal: ${new Date(createdAt).toLocaleString('id-ID')}`);
    lines.push('--------------------------');
    items.forEach((it,i)=> lines.push(`${i+1}. ${it.name||''} (${it.qty} x Rp ${it.price.toLocaleString('id-ID')}) = Rp ${it.subtotal.toLocaleString('id-ID')}`));
    lines.push('--------------------------');
    lines.push(`Ongkir   : Rp ${ongkir.toLocaleString('id-ID')}`);
    tambahans.forEach(t=> lines.push(`${t.type||'Tambahan'}: Rp ${Number(t.nominal).toLocaleString('id-ID')}`));
    lines.push(`TOTAL    : Rp ${total.toLocaleString('id-ID')}`);
    lines.push('');
    lines.push('Terima kasih sudah menggunakan Sahabatku Delivery üôè');

    const text = lines.join('\n');
    el('notaPreview').innerText = text;

    return {
      kurir,noNota,createdAt,
      items,tambahans,ongkir,total,custPhone,text
    };
  }
  

  /* ===================
     Counter No Nota per user
     /counters/{username}/lastNoNota : number
  ====================*/
  async function ensureCounter(){
    if(!currentUser) return;
    if(notaCounterLoaded) return;
    const cRef = ref(db, `counters/${currentUser}`);
    const snap = await get(cRef);
    if(!snap.exists()){
      await set(cRef, { lastNoNota: 0 });
      lastNoNota = 0;
    } else {
      lastNoNota = Number(snap.val().lastNoNota)||0;
    }
    notaCounterLoaded = true;
  }
  async function increaseCounter(){
    await ensureCounter();
    lastNoNota = (Number(lastNoNota)||0) + 1;
    await update(ref(db, `counters/${currentUser}`), { lastNoNota });
    updateNextNotaLabel();
    return lastNoNota;
  }
  function updateNextNotaLabel(){
    el('nextNota').innerText = leftPad((lastNoNota||0)+1);
  }

  /* ===================
     SIMPAN KE FIREBASE
     Struktur:
     - /nota/{username}/{noteId} : {
         kurir,noNota,createdAt,
         items:[{name,qty,price,subtotal}],
         tambahans:[{type,nominal}],
         ongkir,total,custPhone,text
       }
     - /pelacakByNo/{noNota}/{noteId} : {username, createdAt, total}
     - /pelacakByDate/{YYYY-MM-DD}/{noteId} : {username, noNota, total}
     - /counters/{username} : {lastNoNota}
  ====================*/
  async function saveNoteToFirebase(){
    if(!currentUser){ alert('Login dulu.'); return; }
    const data = buildNotaObject();
    // finalize number
    const curNo = await increaseCounter(); // persist
    data.noNota = leftPad(curNo);

    const noteId = 'nota_' + Date.now();
    const noteObj = { id: noteId, ...data };

    // tulis ke /nota/{user}/{noteId}
    await set(ref(db, `nota/${currentUser}/${noteId}`), noteObj);

    // index by No Nota (global-ish)
    await set(ref(db, `pelacakByNo/${data.noNota}/${noteId}`), {
      username: currentUser, createdAt: data.createdAt, total: data.total
    });

    // index by Date
    const keyDate = data.createdAt.slice(0,10);
    await set(ref(db, `pelacakByDate/${keyDate}/${noteId}`), {
      username: currentUser, noNota: data.noNota, total: data.total
    });

    alert(`Nota Tersimpan ‚úÖ (No Nota ${data.noNota})`);
    refreshNotaHistory();
    updatePreviewFilename();
  }

  /* ===================
     RIWAYAT (Realtime)
  ====================*/
  function refreshNotaHistory(){
    if(!currentUser) return;
    const listEl = el('notaHistory'); listEl.innerHTML = 'Memuat...';
    const notesRef = ref(db, `nota/${currentUser}`);
    onValue(notesRef, (snap)=>{
      const val = snap.val()||{};
      const arr = Object.values(val).sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
      if(arr.length===0){ listEl.innerHTML = '<p class="small">Belum ada nota.</p>'; return; }
      let html = '<div class="list-v">';
      arr.forEach(n=>{
        html += `<div style="display:flex;justify-content:space-between;align-items:center;border:1px solid #eef6ff;padding:12px;border-radius:12px;background:#fff;gap:8px">
          <div style="flex:1">
            <div class="small">${new Date(n.createdAt).toLocaleString('id-ID')}</div>
            <div style="fontml,-weight:800">No: ${n.noNota} ‚Ä¢ Total: Rp ${(Number(n.total)||0).toLocaleString('id-ID')}</div>
            <div class="small">${(n.items||[]).length} item ‚Ä¢ Ongkir Rp ${(Number(n.ongkir)||0).toLocaleString('id-ID')}</div>
          </div>
          <div class="btnbar">
            <button class="btn" onclick="viewNote('${n.id}')">Lihat</button>
            <button class="btn danger" onclick="hapusNote('${n.id}')">Hapus</button>
          </div>
        </div>`;
      });
      html += '</div>';
      listEl.innerHTML = html;
    });
  }
  window.viewNote = async (id)=>{
    const snap = await get(ref(db, `nota/${currentUser}/${id}`));
    if(!snap.exists()){ alert('Nota tidak ditemukan'); return; }
    const n = snap.val();
    // isi preview dari data tersimpan
    el('notaPreview').innerText = n.text||'';
    setActiveTab('notaTab');
  };
window.hapusNote = async (id)=>{
    if(!confirm('Hapus nota ini dari Firebase?')) return;
    const snap = await get(ref(db, `nota/${currentUser}/${id}`));
    if(!snap.exists()){ alert('Nota tidak ditemukan'); return; }
    const n = snap.val();

    // 1Ô∏è‚É£ Hapus nota utama
    await remove(ref(db, `nota/${currentUser}/${id}`));

    // 2Ô∏è‚É£ Hapus dari pelacakByNo
    if(n.noNota){
      const pelacakNoRef = ref(db, `pelacakByNo/${n.noNota}/${id}`);
      await remove(pelacakNoRef);
    }

    // 3Ô∏è‚É£ Hapus dari pelacakByDate
    if(n.createdAt){
      const dateKey = n.createdAt.slice(0,10);
      const pelacakDateRef = ref(db, `pelacakByDate/${dateKey}/${id}`);
      await remove(pelacakDateRef);
    }

    // 4Ô∏è‚É£ Update counter lastNoNota
    const allSnap = await get(ref(db, `nota/${currentUser}`));
    let maxNo = 0;
    if(allSnap.exists()){
        Object.values(allSnap.val()).forEach(nota=>{
            const no = Number(nota.noNota) || 0;
            if(no > maxNo) maxNo = no;
        });
    }
    lastNoNota = maxNo;
    await update(ref(db, `counters/${currentUser}`), { lastNoNota });
    updateNextNotaLabel();

    // 5Ô∏è‚É£ Jika nota yang dihapus sedang dibuka di preview, bersihkan preview
    if(window.currentPreviewId === id){
        clearPreviewNota();
        totalPesanan = 0;
        updateTotalPesananLabel();
    }

    alert('Nota berhasil dihapus. Nomor nota berikutnya telah diperbarui.');
    refreshNotaHistory();
};

// Fungsi bantu
function clearPreviewNota(){
    const preview = document.getElementById('previewNota');
    if(preview) preview.innerHTML = '';
    window.currentPreviewId = null;
}

function updateTotalPesananLabel(){
    const label = document.getElementById('totalPesananLabel');
    if(label) label.textContent = totalPesanan;
}



  /* ===================
     REKAP BULANAN
  ====================*/
el('btnLoadRekap').addEventListener('click', async ()=>{
  if(!currentUser){ alert('Login dulu'); return; }
  const ym = el('rekapMonth').value;
  if(!ym){ alert('Pilih bulan'); return; }
  const [year, month] = ym.split('-').map(Number);

  const snap = await get(ref(db, `nota/${currentUser}`));
  const val = snap.val()||{};
  const arr = Object.values(val);
  const byDate = {};

  arr.forEach(n=>{
    const d = new Date(n.createdAt);
    if(d.getFullYear()===year && (d.getMonth()+1)===month){
      const key = n.createdAt.slice(0,10);
      if(!byDate[key]) byDate[key] = {count:0,ongkir:0,tambahan:0,total:0, ids:[]};
      byDate[key].count++;
      byDate[key].ongkir += Number(n.ongkir)||0;
      const t = Array.isArray(n.tambahans) ? n.tambahans.reduce((s,x)=> s+(Number(x.nominal)||0), 0) : 0;
      byDate[key].tambahan += t;
      byDate[key].total += (Number(n.ongkir)||0) + t;
      byDate[key].ids.push(n.id || n._id || n.key); // simpan id nota
    }
  });

  const tbody = el('rekapBody'); 
  tbody.innerHTML='';
  let sumNota=0,sumO=0,sumT=0,sumTot=0;

  Object.keys(byDate).sort().forEach(k=>{
    const v = byDate[k];
    const totalHarian = v.ongkir + v.tambahan;

    const tr = document.createElement('tr');

    // Tanggal jadi bisa diklik untuk update
    const tdDate = document.createElement('td');
    tdDate.innerText = new Date(k).toLocaleDateString('id-ID');
    tdDate.style.cursor = 'pointer';
    tdDate.title = 'Klik untuk ubah tanggal';

    tdDate.addEventListener('click', async ()=>{
      const newDate = prompt('Tanggal baru (YYYY-MM-DD):', k);
      if(!newDate || newDate===k) return;

      const updates = {};
      v.ids.forEach(id=>{
        updates[`${id}/createdAt`] = newDate + val[id].createdAt.slice(10); // tetap ambil jam
      });

      await update(ref(db, `nota/${currentUser}`), updates);
      alert('Tanggal berhasil diupdate');
      el('btnLoadRekap').click(); // refresh tabel otomatis
        const month = el('rekapMonth').value;
        if(!month) return alert('Pilih bulan dulu.');
        const filtered = allNota.filter(n => n.tanggal.slice(0,7) === month);
        renderRekap(filtered);
    });

    tr.appendChild(tdDate);
    tr.innerHTML += `
      <td>${v.count}</td>
      <td>${v.ongkir.toLocaleString('id-ID')}</td>
      <td>${v.tambahan.toLocaleString('id-ID')}</td>
      <td>${totalHarian.toLocaleString('id-ID')}</td>
    `;
    tbody.appendChild(tr);

    sumNota += v.count;
    sumO += v.ongkir; 
    sumT += v.tambahan; 
    sumTot += totalHarian;
  });

  el('sumNota').innerText = sumNota;
  el('sumOngkir').innerText = sumO.toLocaleString('id-ID');
  el('sumTambahan').innerText = sumT.toLocaleString('id-ID');
  el('sumTotal').innerText = sumTot.toLocaleString('id-ID');
});

/* ===================
   PELACAK: Cari No Nota / Tanggal (khusus currentUser)
====================*/
el('btnCariNota').addEventListener('click', async ()=>{
  const no = (el('trackNoNota').value||'').trim();
  const date = (el('trackDate').value||'').trim();
  const hasilEl = el('pelacakHasil');
  hasilEl.innerHTML = 'Mencari...';

  if(!currentUser){ hasilEl.innerHTML = '<p class="small">Login dulu.</p>'; return; }

  let html = '';
  
  // 1Ô∏è‚É£ Cari berdasarkan No Nota
  if(no){
    const s = await get(ref(db, `pelacakByNo/${no}`));
    if(s.exists()){
      const arr = Object.entries(s.val())
                       .map(([id,v]) => ({id, ...v}))
                       .filter(n => n.username === currentUser) // hanya currentUser
                       .sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
      if(arr.length===0){
        html += `<p class="small">No Nota ${no} tidak ditemukan untuk akun ini.</p>`;
      } else {
        html += `<h4>Hasil No Nota ${no}</h4>`;
        arr.forEach(n=>{
          html += `<div class="card" style="padding:10px;margin-bottom:6px">
            <div><b>${new Date(n.createdAt).toLocaleString('id-ID')}</b> ‚Äî Kurir: ${n.username}</div>
            <div>Total: Rp ${(Number(n.total)||0).toLocaleString('id-ID')}</div>
          </div>`;
        });
      }
    } else {
      html += `<p class="small">No Nota ${no} tidak ditemukan.</p>`;
    }
  }

  // 2Ô∏è‚É£ Cari berdasarkan tanggal
  if(date){
    const s = await get(ref(db, `pelacakByDate/${date}`));
    if(s.exists()){
      const arr = Object.entries(s.val())
                       .map(([id,v])=> ({id, ...v}))
                       .filter(n => n.username === currentUser) // filter user
                       .sort((a,b)=> (b.noNota||'').localeCompare(a.noNota||''));
      if(arr.length===0){
        html += `<p class="small">Tidak ada nota untuk tanggal ${date} di akun ini.</p>`;
      } else {
        html += `<h4>Hasil Tanggal ${date}</h4>`;
        arr.forEach(n=>{
          html += `<div class="card" style="padding:10px;margin-bottom:6px">
            <div><b>No Nota: ${n.noNota}</b></div>
            <div>Total: Rp ${(Number(n.total)||0).toLocaleString('id-ID')}</div>
          </div>`;
        });
      }
    } else if(!no){
      html += `<p class="small">Tidak ada nota pada tanggal ${date}.</p>`;
    }
  }

  if(!no && !date){
    html = '<p class="small">Isi No Nota atau Tanggal untuk mencari.</p>';
  }

  hasilEl.innerHTML = html;
});

// Reset pencarian
el('btnCariReset').addEventListener('click', ()=>{
  el('trackNoNota').value = '';
  el('trackDate').value = '';
  el('pelacakHasil').innerHTML = '';
});


  /* ===================
     Export / Share Image (Web)
     - Save Foto: auto download JPG (nama file: {kurir}_nota_{noNota}.jpg)
     - Share WA: pakai Web Share API file, fallback download
  ====================*/
  function canvasToBlob(canvas, type='image/jpeg', quality=0.9){
    return new Promise(res=> canvas.toBlob(b=>res(b), type, quality));
  }
  async function getNotaBlob(){
    const node = el('notaPreview');
    if(!node.innerText.trim()){ buildNotaObject(); }
    const canvas = await html2canvas(node, {scale:2, backgroundColor:'#fff'});
    const blob = await canvasToBlob(canvas, 'image/jpeg', 0.9);
    return blob;
  }

  async function savePreviewAsImage(){
    try{
      const nota = buildNotaObject(); // refresh text
      const blob = await getNotaBlob();
      const filename = `${currentUser||'User'}_nota_${nota.noNota}.jpg`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
      alert('Foto nota diunduh. Cek folder Downloads/Galeri anda.');
    }catch(e){ console.error(e); alert('Gagal simpan foto nota'); }
  }

  async function sharePreviewImage(){
    try{
      const nota = buildNotaObject(); // refresh text
      const blob = await getNotaBlob();
      const filename = `${currentUser||'User'}_nota_${nota.noNota}.jpg`;
      const file = new File([blob], filename, {type:'image/jpeg'});

      if(navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({
          files:[file],
          title:'Nota Sahabatku Delivery',
          text:`No Nota ${nota.noNota} ‚Äî Kurir ${currentUser}`
        });
      } else {
        // Fallback ‚Üí download agar bisa share manual dari Galeri/Downloads
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
        alert('Browser tidak support share langsung. File sudah diunduh, silakan bagikan via WhatsApp dari Galeri/Downloads.');
      }
    }catch(e){ console.error(e); alert('Gagal share nota.'); }
  }

  // Perbarui preview filename saat awal
  updatePreviewFilename();

</script>
</body>        
</html>
