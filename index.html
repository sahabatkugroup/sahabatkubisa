<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sahabatku Delivery - Aplikasi Kurir</title>
<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root{
    --sky:#e6f7ff; --sky-strong:#4dabf7; --accent:#0077c8; --muted:#475b6b; --card:#ffffff;
    --glass: rgba(255,255,255,0.7);
  }
  *{box-sizing:border-box}
  body{
    font-family:Inter,Arial,Helvetica,sans-serif;
    background: linear-gradient(180deg,#f0f8ff 0%, #e6f7ff 60%);
    margin:0;padding:0;color:#083044;
  }
  header{
    background:linear-gradient(90deg,var(--sky-strong),#68bff0);
    color:white;padding:18px 16px;text-align:center;font-weight:800;
    box-shadow:0 6px 30px rgba(4,46,72,0.12);
    position:sticky;top:0;z-index:10;
  }
  .container{max-width:1080px;margin:20px auto;padding:12px}
  .card{
    background:var(--card);
    border-radius:14px;padding:16px;
    box-shadow:0 8px 26px rgba(11,59,90,0.06);
    margin-bottom:16px;border:1px solid rgba(11,59,90,0.04);
  }
  h1,h2,h3{margin:6px 0;color:var(--accent)}
  label{display:block;margin-top:8px;font-size:14px;color:var(--muted)}
  input[type="text"],input[type="password"],input[type="number"],input[type="date"],textarea,select{
    width:100%;padding:10px;border-radius:10px;border:1px solid #e3f2fb;margin-top:6px;background:var(--glass);
    box-sizing:border-box;
  }
  button{
    background:var(--sky-strong);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;margin-top:8px;
    box-shadow: 0 6px 18px rgba(11,59,90,0.08);
  }
  button.secondary{background:#f5f7fa;color:#0b3b5a;border:1px solid rgba(11,59,90,0.03)}
  button.danger{background:#ff6b6b;box-shadow:none}
  nav.tab{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  nav.tab button{flex:1;min-width:140px;padding:10px;border-radius:10px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border:1px solid #e6f2fb;text-align:center}
  th{background:linear-gradient(90deg,var(--sky-strong),#6fc2ff);color:white}
  .nota-box{
    white-space:pre-wrap;font-family:monospace;background:#fbfdff;padding:12px;border-radius:10px;border:1px solid #e6f4ff;
    min-height:100px;overflow:auto;
  }
  .small{font-size:13px;color:var(--muted)}
  footer{text-align:center;color:var(--muted);padding:14px;margin-top:6px}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .right{text-align:right}
  .hidden{display:none}
  .btn-inline{display:inline-block;margin-right:8px}
  .item-card{border:1px solid #e6f4ff;border-radius:12px;padding:10px;margin-top:8px;background:#fff}
  .actions-col{display:flex;flex-direction:column;gap:6px}
  .muted-pill{background:#f0f9ff;color:#0b4870;padding:6px 8px;border-radius:18px;font-weight:600}
  @media (max-width:900px){ .row{flex-direction:column} nav.tab button{min-width:0} }
</style>
</head>
<body>
<header>üöö Sahabatku Delivery ‚Äî Aplikasi Kurir</header>
<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login Kurir</h2>
    <label>Username</label>
    <input id="loginUser" type="text" placeholder="Nama Courier">
    <label>Password</label>
    <input id="loginPass" type="password" placeholder="ID Card Courier">
    <div class="row" style="margin-top:12px">
      <div class="col"><button id="btnLogin">Masuk</button></div>
      <div class="col"><button id="btnDemo" class="secondary"></button></div>
    </div>
    <p id="loginMsg" class="small" style="color:#c0392b"></p>
    <p class="small" style="margin-top:10px"></p>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2>Halo, <span id="curUser" style="color:#0b4870;font-weight:700"></span></h2>
        <div class="small">Buat nota, simpan foto, bagikan ke WhatsApp, dan lihat rekap/pelacakan</div>
      </div>
      <div style="text-align:right">
        <div id="docLinkWrap" class="hidden" style="margin-bottom:8px"><a class="small" id="docLink" href="https://sites.google.com/view/websitekhususkurir/dokumen-sahabatku" target="_blank">üìÑ Dokumen Sahabatku</a></div>
        <button id="btnLogout" class="danger">Logout</button>
      </div>
    </div>

    <div class="card">
      <nav class="tab">
        <button data-tab="notaTab">üìù Nota Elektrik</button>
        <button data-tab="riwayatTab">üìë Riwayat Nota</button>
        <button data-tab="rekapTab">üìä Rekap Bulanan</button>
        <button data-tab="pelacakTab">üìã Pelacak Orderan</button>
        <button data-tab="ongkirTab">üìç Cek Ongkir</button>
      </nav>
      
      <!-- Ongkir TAB -->
      <div id="ongkirTab" class="tabContent">
        <h3>Ongkir Express</h3>
         <div class="brand">
        <i class="fa-solid fa-box"></i>
      </div>
      <div class="headline">Cek Tarif Pengiriman ‚Äì Asal & Tujuan</div>
      <div class="sub">Pilih lokasi lewat pencarian pintar. Bisa isi salah satu atau keduanya. Otomatis hitung sesuai aturan.</div>
    </header>

    <main class="card">
      <div class="card__body">
        <div class="grid">
          <!-- ASAL -->
          <div class="field" id="field-asal">
            <div class="label"><i class="fa-solid fa-location-arrow"></i> Asal (opsional)</div>
            <div class="control">
              <i class="fa-solid fa-magnifying-glass licon"></i>
              <input id="asalInput" class="input" type="text" placeholder="Ketik lokasi asal‚Ä¶ (opsional)"/>
              <button class="clear-btn" title="Bersihkan" id="clearAsal"><i class="fa-solid fa-xmark"></i></button>
              <div class="suggest" id="asalSuggest"></div>
            </div>
          </div>
          <!-- TUJUAN -->
          <div class="field" id="field-tujuan">
            <div class="label"><i class="fa-solid fa-location-dot"></i> Tujuan</div>
            <div class="control">
              <i class="fa-solid fa-magnifying-glass licon"></i>
              <input id="tujuanInput" class="input" type="text" placeholder="Ketik lokasi tujuan‚Ä¶"/>
              <button class="clear-btn" title="Bersihkan" id="clearTujuan"><i class="fa-solid fa-xmark"></i></button>
              <div class="suggest" id="tujuanSuggest"></div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="cekBtn" class="btn btn-primary"><i class="fa-solid fa-calculator"></i> Cek Ongkir</button>
          <button id="bersihkanBtn" class="btn btn-ghost"><i class="fa-solid fa-broom"></i> Bersihkan</button>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <span class="pill"><i class="fa-regular fa-circle-check"></i> Isi salah satu = ongkir normal</span>
          <span class="pill"><i class="fa-regular fa-circle-check"></i> Isi dua-duanya = (Asal + Tujuan) ‚àí 6.000</span>
        </div>

        <div class="results" id="results" style="display:none">
          <div class="kartu">
            <h4><i class="fa-solid fa-tag"></i> Ongkir Normal</h4>
            <div class="harga" id="normalHarga">‚Äì</div>
            <div class="muted" id="normalKeterangan">‚Äî</div>
          </div>
          <div class="kartu">
            <h4><i class="fa-solid fa-route"></i> Ongkir Rute (Asal + Tujuan ‚àí 6.000)</h4>
            <div class="harga" id="ruteHarga">‚Äì</div>
            <div class="muted" id="ruteKeterangan">‚Äî</div>
            <div class="formula" id="ruteFormula" style="display:none"></div>
          </div>
        </div>
      </div>
    </main>

    <p class="footer">¬© 2025 Sahabatku Delivery</p>
  </div>

<script>
  // === DATA: hanya LOKASI & ONGKIR (tanpa zona) ===
  const ongkirData = [
    { lokasi: "JATIBARANG", ongkir: 6000 },
    { lokasi: "JATIBARANG BARU", ongkir: 6000 },
    { lokasi: "GAJAH ASRI", ongkir: 7000 },
    { lokasi: "PILANGSARI", ongkir: 7000 },
    { lokasi: "BINTARA", ongkir: 7000 },
    { lokasi: "GG PROYEK", ongkir: 8000 },
    { lokasi: "JL PANTURA", ongkir: 9000 },
    { lokasi: "BALDES PILANGSARI", ongkir: 10000 },
    { lokasi: "POM BENSIN PANTURA", ongkir: 11000 },
    { lokasi: "COMO", ongkir: 12000 },
    { lokasi: "SUKALILA", ongkir: 13000 },
    { lokasi: "SUKAWERA", ongkir: 13000 },
    { lokasi: "KLIWED", ongkir: 14000 },
    { lokasi: "JL. KERTASMAYA (TELADAN)", ongkir: 16000 },
    { lokasi: "KERTASMAYA", ongkir: 18000 },
    { lokasi: "TULUNGAGUNG", ongkir: 20000 },
    { lokasi: "BINARIA", ongkir: 22000 },
    { lokasi: "JL RAYA KERTASMAYA", ongkir: 25000 },
    { lokasi: "CANDANGPINGGANG", ongkir: 32000 },
    { lokasi: "TERSANA", ongkir: 26000 },
    { lokasi: "JENGKOK", ongkir: 30000 },
    { lokasi: "JAMBE", ongkir: 35000 },
    { lokasi: "BTN SAPHIRE", ongkir: 7000 },
    { lokasi: "KEBULEN", ongkir: 8000 },
    { lokasi: "BANTARAGUNG", ongkir: 8000 },
    { lokasi: "PAWIDEAN", ongkir: 9000 },
    { lokasi: "JATISAWIT", ongkir: 10000 },
    { lokasi: "JATISAWIT LOR", ongkir: 12000 },
    { lokasi: "POM BENSIN JATISAWIT", ongkir: 13000 },
    { lokasi: "KRASAK", ongkir: 14000 },
    { lokasi: "KALIMATI", ongkir: 16000 },
    { lokasi: "LOBENER", ongkir: 18000 },
    { lokasi: "TELUKAGUNG", ongkir: 20000 },
    { lokasi: "PLUMBON", ongkir: 25000 },
    { lokasi: "DUKUH", ongkir: 28000 },
    { lokasi: "PEKANDANGAN JAYA", ongkir: 32000 },
    { lokasi: "PEKANDANGAN", ongkir: 35000 },
    { lokasi: "SINDANG", ongkir: 40000 },
    { lokasi: "INDRAMAYU", ongkir: 40000 },
    { lokasi: "INDARAMAYU KOTA", ongkir: 45000 },
    { lokasi: "KARANGSONG", ongkir: 50000 },
    { lokasi: "WIDASARI", ongkir: 7000 },
    { lokasi: "KONGSI", ongkir: 8000 },
    { lokasi: "UJUNGARIS", ongkir: 9000 },
    { lokasi: "UJUNG JAYA", ongkir: 10000 },
    { lokasi: "RS MITRA", ongkir: 10000 },
    { lokasi: "PONDOK SHIDIQ", ongkir: 11000 },
    { lokasi: "UJUNG PENDOK", ongkir: 12000 },
    { lokasi: "KESESIH", ongkir: 12000 },
    { lokasi: "LEUWIGEDE", ongkir: 13000 },
    { lokasi: "SLAUR", ongkir: 14000 },
    { lokasi: "LEGOK SLAUR", ongkir: 16000 },
    { lokasi: "JL LEGOK", ongkir: 18000 },
    { lokasi: "BOJONG SLAWI", ongkir: 17000 },
    { lokasi: "POLINDRA", ongkir: 18000 },
    { lokasi: "LOHBENER", ongkir: 25000 },
    { lokasi: "PAMAYAHAN", ongkir: 28000 },
    { lokasi: "BANGKIR", ongkir: 32000 },
    { lokasi: "RAMBATAN WETAN", ongkir: 33000 },
    { lokasi: "PANYINDANGAN", ongkir: 35000 },
    { lokasi: "TERUSAN SINDANG", ongkir: 40000 },
    { lokasi: "CELENG", ongkir: 22000 },
    { lokasi: "LARANGAN", ongkir: 26000 },
    { lokasi: "LANGUT", ongkir: 28000 },
    { lokasi: "KASMARAN", ongkir: 20000 },
    { lokasi: "JL WARU - KASMARAN", ongkir: 24000 },
    { lokasi: "WARU", ongkir: 28000 },
    { lokasi: "JL LARANGAN - LELEA", ongkir: 30000 },
    { lokasi: "LELEA", ongkir: 31000 },
    { lokasi: "PASAR LELEA", ongkir: 31000 },
    { lokasi: "TAMANSARI LELEA", ongkir: 33000 },
    { lokasi: "PENGAUBAN", ongkir: 35000 },
    { lokasi: "NUNUK", ongkir: 22000 },
    { lokasi: "TUGU LELEA", ongkir: 37000 },
    { lokasi: "JAMBAK", ongkir: 42000 },
    { lokasi: "CIKEDUNG", ongkir: 45000 },
    { lokasi: "TERISI", ongkir: 50000 },
    { lokasi: "POLSEK/BTN LAMA", ongkir: 7000 },
    { lokasi: "BTN LAMA", ongkir: 7000 },
    { lokasi: "KECAMATAN", ongkir: 7000 },
    { lokasi: "BULAK", ongkir: 8000 },
    { lokasi: "SLEMAN", ongkir: 9000 },
    { lokasi: "TAMBI", ongkir: 10000 },
    { lokasi: "POM PERUM TAMBI", ongkir: 11000 },
    { lokasi: "TOANG TAMBI", ongkir: 13000 },
    { lokasi: "BLOK KASMARAN", ongkir: 16000 },
    { lokasi: "JL MANGIR", ongkir: 20000 },
    { lokasi: "MANGIR", ongkir: 23000 },
    { lokasi: "POLSEK SLIYEG", ongkir: 20000 },
    { lokasi: "SUDIKAMPIRAN", ongkir: 22000 },
    { lokasi: "JAYALAKSANA", ongkir: 24000 },
    { lokasi: "SEGERAN", ongkir: 34000 },
    { lokasi: "MUNDU", ongkir: 36000 },
    { lokasi: "JL RAYA KARANGAMPEL", ongkir: 40000 },
    { lokasi: "KARANGAMPEL", ongkir: 45000 },
    { lokasi: "MAJASARI", ongkir: 14000 },
    { lokasi: "MAJASIH", ongkir: 15000 },
    { lokasi: "JL MAJASIH - SLIYEG", ongkir: 18000 },
    { lokasi: "SLIYEG", ongkir: 20000 },
    { lokasi: "SLIYEG LOR", ongkir: 22000 },
    { lokasi: "GADINGAN", ongkir: 24000 },
    { lokasi: "TUGU SLIYEG", ongkir: 25000 },
    { lokasi: "SUDIMAMPIR", ongkir: 30000 },
    { lokasi: "CANGKINGAN", ongkir: 34000 },
    { lokasi: "KEDOKANBUNDER", ongkir: 40000 },
    { lokasi: "JUNTINYUAT", ongkir: 52000 },
    { lokasi: "LIMBANGAN", ongkir: 56000 },
    { lokasi: "BALONGAN", ongkir: 60000 },
    { lokasi: "BABADAN", ongkir: 24000 },
    { lokasi: "TENAJAR", ongkir: 26000 },
    { lokasi: "BANGKALOA ILIR", ongkir: 8000 },
    { lokasi: "GINCU", ongkir: 9000 },
    { lokasi: "BANGKRONG", ongkir: 10000 },
    { lokasi: "PESONA ASRI/SYIFA", ongkir: 10000 },
    { lokasi: "CURUG TEGALGIRANG", ongkir: 12000 },
    { lokasi: "TEGALGIRANG", ongkir: 13000 },
    { lokasi: "KARANGGETAS", ongkir: 14000 },
    { lokasi: "WANASARI", ongkir: 15000 },
    { lokasi: "CANGKRUNG", ongkir: 16000 },
    { lokasi: "TOANG LAJER", ongkir: 17000 },
    { lokasi: "BOJONG MELATI", ongkir: 18000 },
    { lokasi: "JL BOJONG MELATI", ongkir: 22000 },
    { lokasi: "JL BANGODUA - SUKADANA", ongkir: 25000 },
    { lokasi: "LAJER", ongkir: 18000 },
    { lokasi: "JL LAJER - TUKDANA", ongkir: 20000 },
    { lokasi: "TUKDANA", ongkir: 22000 },
    { lokasi: "KARANGKERTA", ongkir: 25000 },
    { lokasi: "KERTICALA", ongkir: 26000 },
    { lokasi: "SUKADANA", ongkir: 25000 },
    { lokasi: "SUKAPERNA", ongkir: 28000 },
    { lokasi: "CANGKO", ongkir: 30000 },
    { lokasi: "RANCAJAWAT", ongkir: 32000 },
    { lokasi: "GADEL", ongkir: 34000 },
    { lokasi: "BODAS", ongkir: 36000 },
    { lokasi: "PERBATESAN MAJALENGKA", ongkir: 40000 },
    { lokasi: "PERTIGAAN WIDASARI-CBG", ongkir: 7000 },
    { lokasi: "KRANYAR CIBOGOR", ongkir: 8000 },
    { lokasi: "TERUSAN CIBOGOR", ongkir: 9000 },
    { lokasi: "CIBOGOR", ongkir: 10000 },
    { lokasi: "BALDES WIDASARI", ongkir: 12000 },
    { lokasi: "CIDENG", ongkir: 13000 },
    { lokasi: "JIMPRET", ongkir: 16000 },
    { lokasi: "JEMBATAN MAJU", ongkir: 18000 },
    { lokasi: "KALENSARI", ongkir: 18000 },
    { lokasi: "MALANGSARI", ongkir: 20000 }
  ];

  // --- UTIL ---
  const formatRp = (n)=> "Rp" + (n||0).toLocaleString('id-ID');

  function findByName(input){
    if(!input) return null;
    const q = input.trim().toLowerCase();
    if(!q) return null;
    // exact first
    let exact = ongkirData.find(x => x.lokasi.toLowerCase() === q);
    if(exact) return exact;
    // startsWith
    let starts = ongkirData.find(x => x.lokasi.toLowerCase().startsWith(q));
    if(starts) return starts;
    // includes
    let inc = ongkirData.find(x => x.lokasi.toLowerCase().includes(q));
    return inc || null;
  }

  // --- AUTOCOMPLETE ---
  function attachAutocomplete(inputEl, dropdownEl){
    let items = [];
    let active = -1;

    function highlight(txt, query){
      const i = txt.toLowerCase().indexOf(query.toLowerCase());
      if(i<0) return txt;
      return txt.substring(0,i) + "<mark>" + txt.substring(i, i+query.length) + "</mark>" + txt.substring(i+query.length);
    }

    function render(list, query){
      dropdownEl.innerHTML = "";
      list.slice(0, 12).forEach((it, idx)=>{
        const div = document.createElement('div');
        div.className = 's-item';
        div.innerHTML = `
          <div class="s-icon"><i class="fa-solid fa-location-dot"></i></div>
          <div class="s-text">
            <div class="s-name">${highlight(it.lokasi, query)}</div>
            <div class="s-price">${formatRp(it.ongkir)}</div>
          </div>
        `;
        div.addEventListener('click', ()=>{
          inputEl.value = it.lokasi;
          hide();
        });
        dropdownEl.appendChild(div);
      });
      dropdownEl.style.display = list.length ? 'block' : 'none';
      active = -1;
    }

    function hide(){ dropdownEl.style.display='none'; }

    inputEl.addEventListener('input', ()=>{
      const q = inputEl.value.trim();
      if(q.length<1){ hide(); return; }
      const list = ongkirData
        .filter(x => x.lokasi.toLowerCase().includes(q.toLowerCase()))
        .sort((a,b)=> a.lokasi.localeCompare(b.lokasi));
      items = list;
      render(items, q);
    });

    inputEl.addEventListener('keydown', (e)=>{
      const visible = dropdownEl.style.display==='block';
      if(!visible) return;
      const count = dropdownEl.children.length;
      if(e.key === 'ArrowDown'){ e.preventDefault(); active = (active+1) % count; updateActive(); }
      else if(e.key === 'ArrowUp'){ e.preventDefault(); active = (active-1+count) % count; updateActive(); }
      else if(e.key === 'Enter'){
        if(active>=0 && dropdownEl.children[active]){
          e.preventDefault();
          dropdownEl.children[active].click();
        }
      } else if(e.key === 'Escape'){ hide(); }
    });

    function updateActive(){
      [...dropdownEl.children].forEach((el,i)=>{
        el.classList.toggle('active', i===active);
        if(i===active) el.scrollIntoView({block:'nearest'});
      });
    }

    document.addEventListener('click', (e)=>{
      if(!dropdownEl.contains(e.target) && e.target!==inputEl){ hide(); }
    });

    return { hide };
  }

  // --- DOM refs ---
  const asalInput = document.getElementById('asalInput');
  const tujuanInput = document.getElementById('tujuanInput');
  const asalSuggest = document.getElementById('asalSuggest');
  const tujuanSuggest = document.getElementById('tujuanSuggest');

  const normalHarga = document.getElementById('normalHarga');
  const normalKet = document.getElementById('normalKeterangan');
  const ruteHarga = document.getElementById('ruteHarga');
  const ruteKet = document.getElementById('ruteKeterangan');
  const ruteFormula = document.getElementById('ruteFormula');
  const results = document.getElementById('results');

  const { hide: hideAsal } = attachAutocomplete(asalInput, asalSuggest);
  const { hide: hideTujuan } = attachAutocomplete(tujuanInput, tujuanSuggest);

  // Clear buttons
  document.getElementById('clearAsal').addEventListener('click', ()=>{ asalInput.value=''; hideAsal(); });
  document.getElementById('clearTujuan').addEventListener('click', ()=>{ tujuanInput.value=''; hideTujuan(); });

  // Bersihkan global
  document.getElementById('bersihkanBtn').addEventListener('click', ()=>{
    asalInput.value = '';
    tujuanInput.value = '';
    hideAsal(); hideTujuan();
    results.style.display = 'none';
  });

  // CEK
  document.getElementById('cekBtn').addEventListener('click', hitung);
  [asalInput, tujuanInput].forEach(el=>{
    el.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); hitung(); }
    });
  });

  function hitung(){
    const asalText = asalInput.value.trim();
    const tujuanText = tujuanInput.value.trim();

    const asalObj = asalText ? findByName(asalText) : null;
    const tujuanObj = tujuanText ? findByName(tujuanText) : null;

    // Validasi minimal salah satu
    if(!asalObj && !tujuanObj){
      results.style.display = 'none';
      alert('Masukkan minimal salah satu lokasi (Asal atau Tujuan) sesuai daftar.');
      return;
    }
    // Jika user mengetik lokasi yang tidak ada
    if(asalText && !asalObj){ alert('Lokasi Asal tidak ditemukan di daftar.'); return; }
    if(tujuanText && !tujuanObj){ alert('Lokasi Tujuan tidak ditemukan di daftar.'); return; }

    // Ongkir Normal:
    // Prioritas tujuan, kalau kosong pakai asal (sesuai ‚Äúsesuai daftar ongkir‚Äù)
    let normalObj = tujuanObj || asalObj;
    normalHarga.textContent = formatRp(normalObj.ongkir);
    normalKet.textContent = `Lokasi: ${normalObj.lokasi}`;

    // Ongkir Rute (hanya jika dua-duanya ada)
    if(asalObj && tujuanObj){
      const total = Math.max(0, (asalObj.ongkir + tujuanObj.ongkir) - 6000);
      ruteHarga.textContent = formatRp(total);
      ruteKet.textContent = `Asal: ${asalObj.lokasi} (${formatRp(asalObj.ongkir)}) ‚Ä¢ Tujuan: ${tujuanObj.lokasi} (${formatRp(tujuanObj.ongkir)})`;
      ruteFormula.textContent = `${formatRp(asalObj.ongkir)} + ${formatRp(tujuanObj.ongkir)} ‚àí ${formatRp(6000)} = ${formatRp(total)}`;
      ruteFormula.style.display = 'inline-block';
    } else {
      ruteHarga.textContent = '‚Äî';
      ruteKet.textContent = 'Isi Asal & Tujuan untuk menghitung ongkir rute.';
      ruteFormula.style.display = 'none';
    }
    results.style.display = 'grid';
  }

  // Prefocus
  window.addEventListener('load', ()=> tujuanInput.focus() );
</script>
</body>
</html>

      <!-- NOTA TAB -->
      <div id="notaTab" class="tabContent">
        <h3>Buat / Edit Nota Elektronik</h3>

        <div class="card">
          <div class="row">
            <div class="col">
              <label>Nama Kurir</label>
              <input id="kurirName" type="text" readonly>
            </div>
            <div class="col">
              <label>Nomor WhatsApp Customer (format internasional tanpa +)</label>
              <input id="custPhone" type="text" placeholder="6281234... (opsional)">
            </div>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
            <div class="small muted-pill">Items</div>
            <div>
              <button id="btnAddItem" class="btn-inline">+ Tambah Item</button>
              <button id="btnClearItems" class="secondary">Bersihkan</button>
            </div>
          </div>

          <div id="itemsArea" style="margin-top:12px"></div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap">
            <div style="flex:1;min-width:220px">
              <label>Ongkir (Rp)</label>
              <input id="ongkir" type="number" value="0" min="0">
            </div>

            <div style="flex:1;min-width:320px">
              <label>Tambahan Lainnya</label>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="tambahanPreset" style="flex:1">
                  <option value="">-- Pilih preset --</option>
                  <option value="Tambahan Ojeg">Tambahan Ojeg</option>
                  <option value="Tambahan Malam">Tambahan Malam</option>
                  <option value="Tambahan Hujan">Tambahan Hujan</option>
                  <option value="Tambahan Parkir">Tambahan Parkir</option>
                  <option value="Tambahan Melebihi Kapasitas">Tambahan Melebihi Kapasitas</option>
                  <option value="Tambahan Cash Minuman">Tambahan Cash Minuman</option>
                  <option value="Lainnya">Lainnya</option>
                </select>
                <button id="btnAddTambahan" class="btn-inline">+ Tambahan</button>
              </div>
              <div id="tambahanArea" style="margin-top:10px"></div>
            </div>

            <div style="min-width:220px;text-align:right">
              <label>Total Pesanan</label>
              <div style="font-weight:800;font-size:20px;color:#0b4870;padding-top:8px" id="totalPesanan">Rp 0</div>
              <div class="small" style="margin-top:6px">(Termasuk ongkir & tambahan)</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnSaveForm">Simpan Nota</button>
            <button id="btnSavePhoto" class="secondary hidden">Save Foto (Download)</button>
            <button id="btnSharePhoto" class="secondary hidden">Bagikan ke WhatsApp (Foto)</button>
            <button id="btnSaveAndShare" class="btn-inline">Simpan & Simpan Foto & Bagikan</button>
          </div>
        </div>

        <div class="card">
          <h3>Preview Nota</h3>
          <div id="notaPreview" class="nota-box">Belum ada nota.</div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="btnExportPreview" class="secondary">Ekspor Foto Preview</button>
            <button id="btnSharePreview" class="secondary">Bagikan Preview ke WhatsApp</button>
          </div>
          <p class="small" style="margin-top:8px">
            Catatan: share lebih mulus di ponsel dengan Web Share API. Jika tidak tersedia, fallback akan membuka tab baru dengan gambar + link WhatsApp.
          </p>
        </div>
      </div>

      <!-- RIWAYAT TAB -->
      <div id="riwayatTab" class="tabContent hidden">
        <h3>Riwayat Nota (Akun ini)</h3>
        <div id="notaHistory"></div>
      </div>

      <!-- REKAP TAB -->
      <div id="rekapTab" class="tabContent hidden">
        <h3>Rekap Bulanan (dari Nota Elektronik)</h3>
        <div class="row">
          <div class="col">
            <label>Pilih Bulan</label>
            <input id="rekapMonth" type="month">
          </div>
          <div class="col right" style="align-self:end">
            <button id="btnLoadRekap">Muat Rekap</button>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <table aria-label="Rekap Bulanan">
            <thead>
              <tr><th>Tanggal</th><th>Jumlah Nota</th><th>Ongkir (Rp)</th><th>Tambahan (Rp)</th><th>Total Harian (Rp)</th></tr>
            </thead>
            <tbody id="rekapBody"></tbody>
            <tfoot>
              <tr><th>Total Bulan</th><th id="sumNota">0</th><th id="sumOngkir">0</th><th id="sumTambahan">0</th><th id="sumTotal">0</th></tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- PELACAK TAB -->
      <div id="pelacakTab" class="tabContent hidden">
        <h3>Pelacak Orderan (dari Nota)</h3>
        <div class="card">
          <h4>Ringkasan Hari Ini</h4>
          <div id="summaryToday" class="small">Tidak ada data hari ini.</div>
        </div>

        <div class="card">
          <h4>Riwayat Order per Hari</h4>
          <div id="ordersByDay"></div>
        </div>
      </div>

    </div>
  </div>

  <footer class="small">üìÑ <span id="footerDoc" class="hidden"><a href="https://sites.google.com/view/websitekhususkurir/dokumen-sahabatku" target="_blank">Dokumen Sahabatku</a></span> ‚Äî ¬© 2025 Sahabatku Delivery</footer>
</div>

<!-- Modal image viewer -->
<div id="imgModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999">
  <div style="max-width:720px;width:94%;background:white;padding:14px;border-radius:12px;position:relative">
    <div style="text-align:right"><button id="closeImgModal" class="secondary">Tutup</button></div>
    <div style="text-align:center;margin-top:8px">
      <img id="imgModalImg" src="" alt="Nota" style="max-width:100%;height:auto;border-radius:8px;border:1px solid #ddd" />
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button id="modalSaveBtn">Simpan ke Galeri (Download)</button>
        <button id="modalShareBtn" class="secondary">Bagikan ke WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================
   Data model, helpers, storage
   ============================ */
const sampleUsers = {
  "Sonia":"A0103",
  "Alfan":"A0106",
  "Hafiz":"A0108",
  "Gilang":"A0109",
  "Kardianto":"A0110",
  "Eblek":"A0112",
  "Nandar":"A0117",
  "Pitri":"A0115",
  "Robi":"A0118",
  "Hambali":"A0119",
  "Ulum":"A0120",
  "Admin": "A1111"
};
let currentUser = null;
let editingNoteId = null;
let currentSavedNoteId = null;
let modalCurrentNote = null;

/* ---------- Login/Logout ---------- */
document.getElementById('btnDemo').addEventListener('click', ()=>{document.getElementById('loginUser').value='Sonia';document.getElementById('loginPass').value='A0103';});
document.getElementById('btnLogin').addEventListener('click', doLogin);
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(u && sampleUsers[u] && sampleUsers[u] === p){
    currentUser = u;
    localStorage.setItem('currentUser', u);
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('curUser').innerText = currentUser;
    // restore draft if any
    restoreDraftIfAny();
    document.getElementById('docLinkWrap').classList.remove('hidden');
    document.getElementById('footerDoc').classList.remove('hidden');
    initForUser();
  } else {
    document.getElementById('loginMsg').innerText = 'Username/password salah (cek demo).';
  }
}
window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('currentUser');
  if(saved && sampleUsers[saved]){
    document.getElementById('loginUser').value = saved;
    document.getElementById('loginPass').value = sampleUsers[saved];
    doLogin();
  }
});

/* Logout: before logout, save draft (form state) automatically */
document.getElementById('btnLogout').addEventListener('click', ()=>{
  if(currentUser){
    saveDraftBeforeLogout();
  }
  // simulate return to initial login screen:
  localStorage.removeItem('currentUser');
  // reload page to reset UI cleanly
  location.reload();
});

/* ---------- Draft handling (auto-save on logout) ---------- */
function getDraftKey(){ return currentUser + '_draft'; }
function saveDraftBeforeLogout(){
  try{
    const draft = gatherFormDraft();
    localStorage.setItem(getDraftKey(), JSON.stringify(draft));
  }catch(e){ console.warn('Gagal simpan draft', e); }
}
function restoreDraftIfAny(){
  try{
    const raw = localStorage.getItem(getDraftKey());
    if(!raw) return;
    const d = JSON.parse(raw);
    // restore fields to form
    if(d.custPhone) document.getElementById('custPhone').value = d.custPhone;
    if(d.items && Array.isArray(d.items) && d.items.length){
      document.getElementById('itemsArea').innerHTML = '';
      d.items.forEach(it => addItemUI({name:it.name, qty:it.qty, price:it.price}));
    }
    if(typeof d.ongkir !== 'undefined') document.getElementById('ongkir').value = d.ongkir;
    // restore tambahan
    document.getElementById('tambahanArea').innerHTML = '';
    if(d.tambahans && Array.isArray(d.tambahans)){
      d.tambahans.forEach(t => addTambahanUI(t));
    }
    updateTotals();
    // clear draft after restoring so it doesn't auto-apply again
    localStorage.removeItem(getDraftKey());
  }catch(e){ console.warn('gagal restore draft', e); }
}
function gatherFormDraft(){
  // return a plain object representing current form
  const items = [];
  document.querySelectorAll('#itemsArea .item-card').forEach(c=>{
    items.push({
      name: c.querySelector('.iname').value || '',
      qty: Number(c.querySelector('.iqty').value) || 0,
      price: Number(c.querySelector('.iprice').value) || 0
    });
  });
  const tambahans = [];
  document.querySelectorAll('#tambahanArea .tambahan-item').forEach(t=>{
    tambahans.push({
      type: t.querySelector('.t-type').value || '',
      nominal: Number(t.querySelector('.t-nom').value) || 0
    });
  });
  return {
    custPhone: document.getElementById('custPhone').value || '',
    items, ongkir: Number(document.getElementById('ongkir').value) || 0, tambahans
  };
}

/* ---------- Tabs ---------- */
document.querySelectorAll('nav.tab button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.dataset.tab;
    showTab(id);
  });
});
function showTab(id){
  document.querySelectorAll('.tabContent').forEach(t => t.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id === 'rekapTab'){
    const now = new Date();
    document.getElementById('rekapMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    loadRekap();
  } else if(id === 'riwayatTab'){
    refreshNotaHistory();
  } else if(id === 'pelacakTab'){
    renderPelacak();
  }
}

/* ===========================
   Nota: items, tambahan UI
   =========================== */
const itemsArea = document.getElementById('itemsArea');
const tambahanArea = document.getElementById('tambahanArea');
document.getElementById('btnAddItem').addEventListener('click', ()=>addItemUI());
document.getElementById('btnClearItems').addEventListener('click', ()=>{ clearItems(); updateTotals(); });
document.getElementById('ongkir').addEventListener('input', updateTotals);
document.getElementById('tambahanPreset').addEventListener('change', ()=>{ /* user selects preset - not auto add */ });

let itemsCounter = 0;
function addItemUI(pref={}){
  itemsCounter++;
  const id = 'item_' + Date.now() + '_' + itemsCounter;
  const div = document.createElement('div');
  div.className = 'item-card';
  div.dataset.id = id;
  div.innerHTML = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <div style="flex:2"><label>Nama Item</label><input class="iname" type="text" value="${pref.name||''}" placeholder="Contoh: Nasi Goreng"></div>
      <div style="flex:0.8"><label>Qty</label><input class="iqty" type="number" value="${pref.qty||1}" min="1"></div>
      <div style="flex:1"><label>Harga Satuan (Rp)</label><input class="iprice" type="number" value="${pref.price||0}" min="0"></div>
      <div style="flex:0.9;text-align:center"><label>Subtotal</label><div class="isub" style="font-weight:700;padding-top:6px">0</div></div>
      <div style="width:80px"><button class="danger removeBtn" title="Hapus item">Hapus</button></div>
    </div>
  `;
  itemsArea.appendChild(div);
  const inputs = div.querySelectorAll('input');
  inputs.forEach(i => i.addEventListener('input', updateTotals));
  div.querySelector('.removeBtn').addEventListener('click', ()=>{ div.remove(); updateTotals(); });
  updateTotals();
}
function clearItems(){ itemsArea.innerHTML=''; addItemUI(); }

/* Tambahan area (multiple tambahan rows) */
document.getElementById('btnAddTambahan').addEventListener('click', ()=>{
  const preset = document.getElementById('tambahanPreset').value || '';
  addTambahanUI({type:preset, nominal:0});
});

let tambahanCounter = 0;
function addTambahanUI(pref={}){
  tambahanCounter++;
  const id = 'tamb_' + Date.now() + '_' + tambahanCounter;
  const div = document.createElement('div');
  div.className = 'tambahan-item';
  div.style.display = 'flex';
  div.style.gap = '8px';
  div.style.alignItems = 'center';
  div.style.marginTop = '8px';
  div.innerHTML = `
    <select class="t-type" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6f2fb">
      <option ${!pref.type?'selected':''} value="">-- Pilih --</option>
      <option ${pref.type==='Tambahan Ojeg'?'selected':''} value="Tambahan Ojeg">Tambahan Ojeg</option>
      <option ${pref.type==='Tambahan Malam'?'selected':''} value="Tambahan Malam">Tambahan Malam</option>
      <option ${pref.type==='Tambahan Tempat'?'selected':''} value="Tambahan Tempat">Tambahan Tempat</option>
      <option ${pref.type==='Tambahan Hujan'?'selected':''} value="Tambahan Hujan">Tambahan Hujan</option>
      <option ${pref.type==='Tambahan Parkir'?'selected':''} value="Tambahan Parkir">Tambahan Parkir</option>
      <option ${pref.type==='Tambahan Melebihi Kapasitas'?'selected':''} value="Tambahan Melebihi Kapasitas">Tambahan Melebihi Kapasitas</option>
      <option ${pref.type==='Tambahan Cash Minuman'?'selected':''} value="Tambahan Cash Minuman">Tambahan Cash Minuman</option>
      <option ${pref.type==='Lainnya'?'selected':''} value="Lainnya">Lainnya</option>
    </select>
    <input class="t-nom" type="number" min="0" value="${pref.nominal||0}" style="width:160px;border-radius:8px;padding:8px;border:1px solid #e6f2fb" placeholder="Nominal (Rp)">
    <button class="secondary t-remove">Hapus</button>
  `;
  tambahanArea.appendChild(div);
  div.querySelector('.t-type').addEventListener('change', updateTotals);
  div.querySelector('.t-nom').addEventListener('input', updateTotals);
  div.querySelector('.t-remove').addEventListener('click', ()=>{ div.remove(); updateTotals(); });
  updateTotals();
}

/* Update totals */
function updateTotals(){
  let total = 0;
  document.querySelectorAll('#itemsArea .item-card').forEach(c=>{
    const qty = Number(c.querySelector('.iqty').value) || 0;
    const price = Number(c.querySelector('.iprice').value) || 0;
    const sub = qty * price;
    c.querySelector('.isub').innerText = sub.toLocaleString('id-ID');
    total += sub;
  });
  const ong = Number(document.getElementById('ongkir').value) || 0;
  let sumTamb = 0;
  document.querySelectorAll('#tambahanArea .tambahan-item').forEach(t=>{
    sumTamb += Number(t.querySelector('.t-nom').value) || 0;
  });
  total += ong + sumTamb;
  document.getElementById('totalPesanan').innerText = 'Rp ' + total.toLocaleString('id-ID');
  return total;
}

/* ---------- Preview generation ---------- */
function generatePreviewFromForm(){
  const items = [];
  let subtotal = 0;
  document.querySelectorAll('#itemsArea .item-card').forEach(c=>{
    const name = (c.querySelector('.iname').value||'').trim();
    const qty = Number(c.querySelector('.iqty').value) || 0;
    const price = Number(c.querySelector('.iprice').value) || 0;
    const sub = qty * price;
    items.push({name, qty, price, subtotal: sub});
    subtotal += sub;
  });
  const ongkir = Number(document.getElementById('ongkir').value) || 0;
  const tambahans = [];
  let tambahanTotal = 0;
  document.querySelectorAll('#tambahanArea .tambahan-item').forEach(t=>{
    const type = t.querySelector('.t-type').value || '';
    const nominal = Number(t.querySelector('.t-nom').value) || 0;
    if(type || nominal) tambahans.push({type, nominal});
    tambahanTotal += nominal;
  });
  const custPhone = (document.getElementById('custPhone').value || '').replace(/\D/g,'');
  const kurir = currentUser || document.getElementById('kurirName').value || '';
  const total = subtotal + ongkir + tambahanTotal;

  const lines = [];
  lines.push('üßæ NOTA SAHABATKU DELIVERY');
  lines.push('==========================');
  lines.push(`Kurir: ${kurir}`);
  lines.push('--------------------------');
  items.forEach((it,i)=>{
    lines.push(`${i+1}. ${it.name || '(tanpa nama)'} (${it.qty} x Rp ${it.price.toLocaleString('id-ID')}) = Rp ${it.subtotal.toLocaleString('id-ID')}`);
  });
  lines.push('--------------------------');
  lines.push(`Ongkir: Rp ${ongkir.toLocaleString('id-ID')}`);
  if(tambahans.length){
    tambahans.forEach(t=> lines.push(`${t.type || 'Tambahan'}: Rp ${Number(t.nominal).toLocaleString('id-ID')}`));
  }
  lines.push(`TOTAL: Rp ${total.toLocaleString('id-ID')}`);
  lines.push('');
  lines.push('Terimakasih sudah menggunakan jasa Sahabatku Delivery');
  lines.push('Ditunggu orderan selanjutnya üôè');

  document.getElementById('notaPreview').innerText = lines.join('\n');

  return {
    items, ongkir, tambahans, total, custPhone, text: lines.join('\n'), kurir
  };
}

/* ---------- Create image from preview using html2canvas ---------- */
async function createImageFromPreview(quality=0.7){
  const node = document.getElementById('notaPreview');
  if(!node.innerText.trim()) throw new Error('Belum ada preview');
  const canvas = await html2canvas(node, {scale:2, backgroundColor:'#ffffff', scrollY: -window.scrollY});
  return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
}

/* ---------- Utils blob/dataURL/download/share ---------- */
function blobToDataURL(blob){
  return new Promise(res=>{
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.readAsDataURL(blob);
  });
}
function dataURLToBlob(dataURL){
  const parts = dataURL.split(';base64,');
  const mime = parts[0].split(':')[1];
  const bstr = atob(parts[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], {type:mime});
}
function downloadDataURL(dataURL, filename){
  const a = document.createElement('a');
  a.href = dataURL;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
async function shareDataURLWithFallback(dataURL, custPhone=''){
  try{
    const blob = dataURLToBlob(dataURL);
    const file = new File([blob], `nota_${Date.now()}.jpg`, {type: 'image/jpeg'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title: 'Nota Sahabatku', text: 'Nota pesanan Anda'});
      if(custPhone) window.open(`https://wa.me/${custPhone}`, '_blank');
      return;
    } else {
      const win = window.open('', '_blank');
      win.document.write(`<p style="font-family:Arial,Helvetica,sans-serif">Simpan gambar lalu kirim ke WhatsApp.</p>`);
      win.document.write(`<img src="${dataURL}" style="max-width:100%;height:auto;border:1px solid #ccc;border-radius:8px" />`);
      if(custPhone) win.document.write(`<p><a href="https://wa.me/${custPhone}" target="_blank">Buka chat ke ${custPhone}</a></p>`);
    }
  }catch(e){
    console.error(e);
    const win = window.open('', '_blank');
    win.document.write(`<img src="${dataURL}" style="max-width:100%;height:auto;border:1px solid #ccc;border-radius:8px" />`);
    if(custPhone) win.document.write(`<p><a href="https://wa.me/${custPhone}" target="_blank">Buka chat ke ${custPhone}</a></p>`);
  }
}

/* ===========================
   Save / Edit / History / Image
   =========================== */
function getNotesArray(){ return JSON.parse(localStorage.getItem(currentUser + '_notas') || '[]'); }
function saveNotesArray(arr){ localStorage.setItem(currentUser + '_notas', JSON.stringify(arr)); }

document.getElementById('btnSaveForm').addEventListener('click', saveNoteFromForm);
document.getElementById('btnSavePhoto').addEventListener('click', savePhotoOfCurrentNote);
document.getElementById('btnSharePhoto').addEventListener('click', sharePhotoOfCurrentNote);
document.getElementById('btnSaveAndShare').addEventListener('click', async ()=>{
  const note = await saveNoteFromForm();
  if(note){
    currentSavedNoteId = note.id;
    await savePhotoOfCurrentNote();
    await sharePhotoOfCurrentNote();
  }
});
document.getElementById('btnExportPreview').addEventListener('click', exportPreviewAsImage);
document.getElementById('btnSharePreview').addEventListener('click', sharePreviewImage);

async function saveNoteFromForm(){
  const preview = generatePreviewFromForm();
  if(!currentUser){ alert('Login dulu.'); return null; }
  const key = currentUser + '_notas';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');

  const noteObj = {
    id: editingNoteId || ('nota_' + Date.now()),
    createdAt: editingNoteId ? getNotesArray().find(n=>n.id===editingNoteId).createdAt : new Date().toISOString(),
    items: preview.items,
    ongkir: preview.ongkir,
    tambahans: preview.tambahans,
    total: preview.total,
    custPhone: preview.custPhone,
    text: preview.text,
    kurir: preview.kurir,
    imageData: null
  };

  if(editingNoteId){
    const idx = arr.findIndex(n => n.id === editingNoteId);
    if(idx >= 0) arr[idx] = {...arr[idx], ...noteObj};
    editingNoteId = null;
  } else {
    arr.unshift(noteObj);
  }
  saveNotesArray(arr);
  refreshNotaHistory();
  renderPelacak();
  loadRekap();
  currentSavedNoteId = noteObj.id;
  document.getElementById('btnSavePhoto').classList.remove('hidden');
  document.getElementById('btnSharePhoto').classList.remove('hidden');
  alert('Nota berhasil disimpan.');
  return noteObj;
}

/* Save photo for a saved note (download + attach to note) */
async function savePhotoOfCurrentNote(){
  if(!currentSavedNoteId){ alert('Pilih nota yang sudah disimpan (lihat riwayat) atau simpan terlebih dulu.'); return; }
  const arr = getNotesArray();
  const note = arr.find(n => n.id === currentSavedNoteId);
  if(!note){ alert('Nota tidak ditemukan.'); return; }
  try{
    // regenerate preview based on saved note content (ensuring preview reflects saved)
    // create temporary preview UI from note.text
    document.getElementById('notaPreview').innerText = note.text;
    const blob = await createImageFromPreview(0.65);
    const dataURL = await blobToDataURL(blob);
    note.imageData = dataURL;
    saveNotesArray(arr);
    // download to gallery
    downloadDataURL(dataURL, `nota_${currentUser}_${Date.now()}.jpg`);
    alert('Foto nota tersimpan & di-download ke galeri.');
  }catch(e){ console.error(e); alert('Gagal menyimpan foto nota.'); }
}

/* Share photo for current saved note */
async function sharePhotoOfCurrentNote(){
  if(!currentSavedNoteId){ alert('Pilih nota tersimpan dulu.'); return; }
  const arr = getNotesArray();
  const note = arr.find(n => n.id === currentSavedNoteId);
  if(!note){ alert('Nota tidak ditemukan'); return; }
  if(!note.imageData){
    await savePhotoOfCurrentNote();
    const arr2 = getNotesArray();
    const n2 = arr2.find(x=>x.id===currentSavedNoteId);
    if(n2 && n2.imageData) return shareDataURLWithFallback(n2.imageData, n2.custPhone);
    return;
  } else {
    return shareDataURLWithFallback(note.imageData, note.custPhone);
  }
}

/* Export/Share preview without saving */
async function exportPreviewAsImage(){
  try{
    const blob = await createImageFromPreview(0.7);
    const dataURL = await blobToDataURL(blob);
    downloadDataURL(dataURL, `nota_preview_${Date.now()}.jpg`);
    alert('Preview di-download ke galeri.');
  }catch(e){ console.error(e); alert('Gagal ekspor preview.'); }
}
async function sharePreviewImage(){
  try{
    const blob = await createImageFromPreview(0.7);
    const dataURL = await blobToDataURL(blob);
    await shareDataURLWithFallback(dataURL, (document.getElementById('custPhone').value||'').replace(/\D/g,''));
  }catch(e){ console.error(e); alert('Gagal share preview.'); }
}

/* ---------- History UI (lihat/edit/hapus/save/share) ---------- */
function refreshNotaHistory(){
  refreshNotaHistoryUI();
  renderPelacak();
}

function refreshNotaHistoryUI(){
  if(!currentUser) return;
  const arr = getNotesArray();
  const el = document.getElementById('notaHistory');
  if(!arr.length){ el.innerHTML = '<p class="small">Belum ada nota tersimpan.</p>'; return; }
  let html = '<div style="display:flex;flex-direction:column;gap:12px">';
  arr.forEach(n=>{
    html += `<div style="display:flex;justify-content:space-between;align-items:center;border:1px solid #eef6ff;padding:12px;border-radius:10px;background:linear-gradient(180deg, #ffffff, #fbfeff)">
      <div style="flex:1">
        <div class="small">${new Date(n.createdAt).toLocaleString('id-ID')}</div>
        <div style="font-weight:700">Total: Rp ${Number(n.total).toLocaleString('id-ID')}</div>
        <div class="small">Tambahan: ${n.tambahans && n.tambahans.length ? n.tambahans.map(t=>`${t.type||'-'} Rp ${Number(t.nominal).toLocaleString('id-ID')}`).join(', ') : '-'}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button onclick="handleViewNote('${n.id}')">Lihat</button>
        <button onclick="handleEditNote('${n.id}')" class="secondary">Edit</button>
        <button onclick="handleSavePhoto('${n.id}')" class="btn-inline">Save Foto</button>
        <button onclick="handleShareNote('${n.id}')" class="btn-inline secondary">Bagikan</button>
        <button onclick="handleDeleteNote('${n.id}')" class="danger">Hapus</button>
      </div>
    </div>`;
  });
  html += '</div>';
  el.innerHTML = html;
}

/* Actions */
function handleViewNote(id){
  const arr = getNotesArray();
  const n = arr.find(x=>x.id===id);
  if(!n){ alert('Nota tidak ditemukan'); return; }
  document.getElementById('notaPreview').innerText = n.text;
  currentSavedNoteId = n.id;
  document.getElementById('btnSavePhoto').classList.remove('hidden');
  document.getElementById('btnSharePhoto').classList.remove('hidden');
  if(n.imageData){
    openImageModal(n.imageData, n);
  } else {
    if(confirm('Foto belum tersedia. Buat ulang foto sekarang dan simpan ke galeri?')){
      recreateImageFromNote(n.id);
    }
  }
}

function handleEditNote(id){
  const arr = getNotesArray();
  const n = arr.find(x=>x.id===id);
  if(!n) return alert('Nota tidak ditemukan');
  editingNoteId = id;
  currentSavedNoteId = id;
  document.getElementById('custPhone').value = n.custPhone || '';
  document.getElementById('kurirName').value = n.kurir || currentUser;
  // populate items
  document.getElementById('itemsArea').innerHTML = '';
  (n.items||[]).forEach(it => addItemUI({name:it.name, qty:it.qty, price:it.price}));
  // populate tambahan
  document.getElementById('tambahanArea').innerHTML = '';
  (n.tambahans||[]).forEach(t=> addTambahanUI({type:t.type, nominal:t.nominal}));
  document.getElementById('ongkir').value = n.ongkir || 0;
  updateTotals();
  // show save/photo buttons
  document.getElementById('btnSavePhoto').classList.remove('hidden');
  document.getElementById('btnSharePhoto').classList.remove('hidden');
  showTab('notaTab');
}

async function handleSavePhoto(id){
  const arr = getNotesArray();
  const n = arr.find(x=>x.id===id);
  if(!n) return alert('Nota tidak ditemukan');
  if(n.imageData){
    downloadDataURL(n.imageData, `nota_${currentUser}_${Date.now()}.jpg`);
    alert('Foto di-download ulang ke galeri.');
  } else {
    await recreateImageFromNote(id);
  }
}

async function handleShareNote(id){
  const arr = getNotesArray();
  const n = arr.find(x=>x.id===id);
  if(!n) return alert('Nota tidak ditemukan');
  if(n.imageData){
    shareDataURLWithFallback(n.imageData, n.custPhone);
  } else {
    const url = await recreateImageFromNote(id);
    if(url) shareDataURLWithFallback(url, n.custPhone);
  }
}

function handleDeleteNote(id){
  if(!confirm('Hapus nota dari riwayat? (Rekap/pelacak akan diperbarui)')) return;
  let arr = getNotesArray();
  arr = arr.filter(x=>x.id !== id);
  saveNotesArray(arr);
  refreshNotaHistory();
  loadRekap();
  renderPelacak();
}

/* ---------- Recreate image from a saved note ---------- */
async function recreateImageFromNote(id){
  const arr = getNotesArray();
  const n = arr.find(x=>x.id===id);
  if(!n) return null;
  // create simple node using n.text
  const temp = document.createElement('div');
  temp.style.width = '700px';
  temp.style.padding = '14px';
  temp.style.background = '#ffffff';
  temp.style.color = '#000';
  temp.style.fontFamily = 'Arial, sans-serif';
  temp.style.fontSize = '14px';
  temp.innerHTML = `<div style="font-weight:700;color:#0b4870;font-size:18px">Sahabatku Delivery</div>
    <div style="margin-top:8px;white-space:pre-wrap;">${n.text.replace(/\n/g,'<br>')}</div>`;
  document.body.appendChild(temp);
  try{
    const canvas = await html2canvas(temp, {scale:2, backgroundColor:'#ffffff'});
    const dataURL = canvas.toDataURL('image/jpeg', 0.68);
    const idx = arr.findIndex(x=>x.id===id);
    if(idx >= 0){ arr[idx].imageData = dataURL; saveNotesArray(arr); refreshNotaHistory(); }
    downloadDataURL(dataURL, `nota_${currentUser}_${Date.now()}.jpg`);
    alert('Foto nota dibuat ulang & di-download ke galeri.');
    return dataURL;
  }catch(e){ console.error(e); alert('Gagal membuat ulang gambar nota.'); return null; }
  finally{ temp.remove(); }
}

/* ---------- Modal viewer ---------- */
const imgModal = document.getElementById('imgModal');
const imgModalImg = document.getElementById('imgModalImg');
document.getElementById('closeImgModal').addEventListener('click', ()=> imgModal.style.display='none');
document.getElementById('modalSaveBtn').addEventListener('click', ()=>{ if(modalCurrentNote && modalCurrentNote.imageData){ downloadDataURL(modalCurrentNote.imageData, `nota_${currentUser}_${Date.now()}.jpg`); alert('Gambar di-download.'); }});
document.getElementById('modalShareBtn').addEventListener('click', ()=>{ if(modalCurrentNote && modalCurrentNote.imageData) shareDataURLWithFallback(modalCurrentNote.imageData, modalCurrentNote.custPhone); });
function openImageModal(dataURL, noteObj){ modalCurrentNote = noteObj; imgModalImg.src = dataURL; imgModal.style.display='flex'; }

/* ---------- Pelacak & Rekap (computed dari notes) ---------- */
function renderPelacak(){
  const arr = getNotesArray();
  const today = new Date().toISOString().slice(0,10);
  const todayNotes = arr.filter(n => n.createdAt.slice(0,10) === today);
  const sumToday = todayNotes.reduce((s,n)=> s + (Number(n.total)||0), 0);
  const summaryEl = document.getElementById('summaryToday');
  if(todayNotes.length===0) summaryEl.innerText = 'Tidak ada order hari ini.';
  else summaryEl.innerHTML = `${todayNotes.length} order hari ini ‚Äî Total Rp ${sumToday.toLocaleString('id-ID')}`;

  // group by day
  const byDay = {};
  arr.forEach(n=>{
    const d = n.createdAt.slice(0,10);
    if(!byDay[d]) byDay[d] = {count:0,total:0};
    byDay[d].count++; byDay[d].total += Number(n.total)||0;
  });
  const ordersByDayEl = document.getElementById('ordersByDay');
  let html = '';
  const days = Object.keys(byDay).sort((a,b)=> b.localeCompare(a));
  if(days.length===0) html = '<p class="small">Belum ada order</p>';
  else days.forEach(d=>{
    html += `<div style="border:1px solid #eef6ff;padding:10px;border-radius:8px;margin-bottom:8px">
      <div><b>${new Date(d).toLocaleDateString('id-ID')}</b></div>
      <div class="small">Order: ${byDay[d].count} ‚Äî Total: Rp ${byDay[d].total.toLocaleString('id-ID')}</div>
    </div>`;
  });
  ordersByDayEl.innerHTML = html;
}

/* Rekap bulanan (from notes: count, ongkir, tambahans, total) */
document.getElementById('btnLoadRekap').addEventListener('click', loadRekap);
function loadRekap(){
  const ym = document.getElementById('rekapMonth').value;
  if(!ym){ alert('Pilih bulan'); return; }
  const [year, month] = ym.split('-').map(Number);
  const arr = getNotesArray();
  const byDate = {};
  arr.forEach(n=>{
    const d = new Date(n.createdAt);
    if(d.getFullYear()===year && (d.getMonth()+1)===month){
      const key = n.createdAt.slice(0,10);// YYYY-MM-DD
      if(!byDate[key]) byDate[key] = {count:0,ongkir:0,tambahan:0,total:0};
      byDate[key].count++;
      byDate[key].ongkir += Number(n.ongkir)||0;
      if(Array.isArray(n.tambahans)) {
        byDate[key].tambahan += n.tambahans.reduce((s,t)=> s + (Number(t.nominal)||0), 0);
    }
      byDate[key].total = byDate[key].ongkir + byDate[key].tambahan;
    }
  });
  const tbody = document.getElementById('rekapBody'); tbody.innerHTML = '';
  let sumNota=0,sumO=0,sumT=0,sumTot=0;
  Object.keys(byDate).sort().forEach(k=>{
    const v = byDate[k];
    tbody.innerHTML += `<tr><td>${new Date(k).toLocaleDateString('id-ID')}</td><td>${v.count}</td><td>${v.ongkir.toLocaleString('id-ID')}</td><td>${v.tambahan.toLocaleString('id-ID')}</td><td>${v.total.toLocaleString('id-ID')}</td></tr>`;
    sumNota += v.count; sumO += v.ongkir; sumT += v.tambahan; sumTot += v.total;
  });
  document.getElementById('sumNota').innerText = sumNota;
  document.getElementById('sumOngkir').innerText = sumO.toLocaleString('id-ID');
  document.getElementById('sumTambahan').innerText = sumT.toLocaleString('id-ID');
  document.getElementById('sumTotal').innerText = sumTot.toLocaleString('id-ID');
}

/* ---------- Init / helpers ---------- */
function initForUser(){
  document.getElementById('curUser').innerText = currentUser;
  document.getElementById('kurirName').value = currentUser;
  clearItems();
  // ensure at least one tambahan area empty
  tambahanArea.innerHTML = '';
  updateTotals();
  refreshNotaHistory();
  renderPelacak();
  showTab('notaTab');
  // reveal doc link
  document.getElementById('docLinkWrap').classList.remove('hidden');
  document.getElementById('footerDoc').classList.remove('hidden');
}

/* expose for console debugging */
window.createImageFromPreview = createImageFromPreview;
window.generatePreviewFromForm = generatePreviewFromForm;

</script>
<script>
// ... script kamu yang sudah ada ...

/* Auto-save setiap ada input di form nota */
function enableAutoSaveForm(){
  const formEls = document.querySelectorAll(
    '#custPhone, #itemsArea input, #ongkir, #tambahanArea input, #tambahanArea select'
  );

  formEls.forEach(el=>{
    el.addEventListener('input', ()=>{
      const draft = gatherFormDraft();
      localStorage.setItem(getDraftKey(), JSON.stringify(draft));
    });
  });
}

// Modifikasi sedikit di doLogin supaya auto-save aktif setelah login
function doLogin(){
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  if(users[user] && users[user].password===pass){
    loggedUser=user;
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    initForUser();
    restoreDraftIfAny();
    enableAutoSaveForm(); // <<=== tambahkan ini
  } else {
    document.getElementById('loginError').innerText='Username atau password salah';
  }
}
</script>
<script>
// ... script kamu ...

function logout(){
  loggedUser = null;
  document.getElementById('app').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
}

</script>
</body>
</html>
